# Rediså¤§æ€å™¨ï¼Œæ·±å…¥å‰–æï¼Œä»ç®€å…¥æ·±
æœ¬æ–‡å°†ä»¥ç®€æ´çš„å›¾æ–‡æ¥é˜è¿°**Redis**ï¼Œå»ºç«‹èµ·å¯¹redisçš„é€å½»å°è±¡ï¼ŒåŒæ—¶ä¹Ÿä¼šå¯¹redisåœ¨ä¼ä¸šå®æˆ˜ä¸­çš„ä¸€äº›ä¼˜åŒ–æ¥åšæ·±åº¦å‰–æï¼Œç›®çš„æ˜¯æ‹¿æredisä¸æ±‚äººã€‚ 

* * *

**Redis**æ˜¯ä»€ä¹ˆï¼Ÿ **ï¼ˆRemote Dictionary Server )-è¿œç¨‹å­—å…¸æœåŠ¡** æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„é”®å€¼å¯¹ï¼ˆkey-valueï¼‰å­˜å‚¨ç³»ç»Ÿã€‚å®ƒé€šå¸¸è¢«ç”¨ä½œ**ç¼“å­˜å±‚**ï¼Œä»¥æå‡åº”ç”¨ç¨‹åºçš„æ€§èƒ½ã€‚Redisæ˜¯å†…å­˜ä¸­çš„æ•°æ®ç»“æ„å­˜å‚¨ç³»ç»Ÿï¼Œè¿™æ„å‘³ç€æ‰€æœ‰çš„æ•°æ®éƒ½å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œä½¿å¾—è¯»å–å’Œå†™å…¥æ“ä½œéƒ½éå¸¸å¿«é€Ÿã€‚

* * *

[rediså®‰è£…å‚è€ƒåœ°å€](https://link.juejin.cn/?target=https%3A%2F%2Fmnpq-dgz.blog.csdn.net%2Farticle%2Fdetails%2F134233056%3Fspm%3D1001.2014.3001.5502 "https://mnpq-dgz.blog.csdn.net/article/details/134233056?spm=1001.2014.3001.5502")

* * *

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/42f0a922cd4c40f6a0bf17c0c73a6e3b~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=4000&h=1188&s=575100&e=png&b=f8faed)

*   å­—ç¬¦ä¸²ï¼ˆstringï¼‰ï¼šå­—ç¬¦ä¸²æ˜¯ Redis æœ€åŸºæœ¬çš„æ•°æ®ç±»å‹ï¼Œä¸€ä¸ªé”®æœ€å¤§çš„å­˜å‚¨å®¹é‡æ˜¯ 512MBã€‚
*   å“ˆå¸Œè¡¨ï¼ˆhashï¼‰ï¼šå“ˆå¸Œè¡¨å­˜å‚¨çš„æ˜¯é”®å€¼å¯¹ï¼Œå¯ä»¥ç†è§£ä¸ºä¸€ä¸ªå­—å…¸ã€‚æ¯ä¸ªå“ˆå¸Œè¡¨æœ€å¤šå¯ä»¥å­˜å‚¨ 2^32 - 1 ä¸ªé”®å€¼å¯¹ï¼ˆ40å¤šäº¿ï¼‰ã€‚
*   åˆ—è¡¨ï¼ˆlistï¼‰ï¼šåˆ—è¡¨æ˜¯ä¸€ä¸ªæœ‰åºçš„å­—ç¬¦ä¸²ç±»å‹æ•°æ®é›†åˆï¼Œå¯ä»¥ç†è§£ä¸ºä¸€ä¸ªæ•°ç»„ã€‚ä¸€ä¸ªåˆ—è¡¨æœ€å¤šå¯ä»¥åŒ…å« 2^32 - 1 ä¸ªå…ƒç´ ï¼ˆ40å¤šäº¿ï¼‰ã€‚
*   é›†åˆï¼ˆsetï¼‰ï¼šé›†åˆæ˜¯ä¸€ä¸ªæ— åºçš„å­—ç¬¦ä¸²ç±»å‹æ•°æ®é›†åˆï¼Œä¸å…è®¸é‡å¤å…ƒç´ ã€‚
*   æœ‰åºé›†åˆï¼ˆsorted setï¼‰ï¼šæœ‰åºé›†åˆæ˜¯ä¸€ä¸ªæœ‰åºçš„å­—ç¬¦ä¸²ç±»å‹æ•°æ®é›†åˆï¼Œæ¯ä¸ªå…ƒç´ éƒ½æœ‰ä¸€ä¸ªåˆ†æ•°å€¼ï¼ˆscoreï¼‰ï¼Œå¯ä»¥ç†è§£ä¸ºå¸¦æƒé‡çš„å…ƒç´ ã€‚
*   ä½å›¾ï¼ˆbitmapï¼‰ï¼šç”±äºŒè¿›åˆ¶ä½ç»„æˆçš„æ•°æ®ç±»å‹ï¼Œå¯ä»¥å¯¹å…¶è¿›è¡Œä½è¿ç®—ã€‚
*   åœ°ç†ä½ç½®ï¼ˆgeospatialï¼‰ï¼šå¯ä»¥å‚¨å­˜åœ°ç†ä½ç½®çš„æ•°æ®ç±»å‹ï¼Œæ”¯æŒè·ç¦»è®¡ç®—å’Œåœ°ç†èŒƒå›´æŸ¥è¯¢ã€‚
*   Redis 5.0 ç‰ˆæœ¬å¼•å…¥äº† Stream æ•°æ®ç»“æ„ï¼Œå®ƒæä¾›äº†åŸºäºæ¶ˆæ¯çš„å¤„ç†æ–¹å¼ã€‚
*   HyperLogLogï¼šç”¨äºè¿›è¡ŒåŸºæ•°ç»Ÿè®¡ï¼Œå³ç»Ÿè®¡ä¸åŒå…ƒç´ çš„æ•°é‡ã€‚

* * *

Â Â è™½ç„¶Redisä¸»è¦å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œä½†ä¸ºäº†é˜²æ­¢æ•°æ®ä¸¢å¤±ï¼Œä½ å¯ä»¥ä½¿ç”¨æŒä¹…åŒ–åŠŸèƒ½ã€‚Redisæ”¯æŒä¸¤ç§æŒä¹…åŒ–æ–¹æ³•ï¼šRDBï¼ˆRedis DataBaseï¼‰å’ŒAOFï¼ˆAppend Only Fileï¼‰ã€‚RDBé€šè¿‡ç”Ÿæˆæ•°æ®å¿«ç…§è¿›è¡ŒæŒä¹…åŒ–ï¼Œè€ŒAOFåˆ™é€šè¿‡è®°å½•æ¯æ¬¡å†™æ“ä½œè¿›è¡ŒæŒä¹…åŒ–ã€‚

**RDBæŒä¹…åŒ–** ![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ed52c7b7035d4f6cac78bb860588d9e4~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1117&h=780&s=55282&e=jpg&b=fffcfc)
 RedisæŸä¸€æ—¶åˆ»çš„æ•°æ®æŒä¹…åŒ–åˆ°ç£ç›˜ä¸­ï¼Œæ˜¯ä¸€ç§å¿«ç…§å¼çš„æŒä¹…åŒ–æ–¹æ³•ã€‚

Redisåœ¨è¿›è¡Œæ•°æ®æŒä¹…åŒ–çš„è¿‡ç¨‹ä¸­ï¼Œä¼šå…ˆå°†æ•°æ®å†™å…¥åˆ°ä¸€ä¸ªä¸´æ—¶æ–‡ä»¶ä¸­ï¼Œå¾…æŒä¹…åŒ–è¿‡ç¨‹éƒ½ç»“æŸäº†ï¼Œæ‰ä¼šç”¨è¿™ä¸ªä¸´æ—¶æ–‡ä»¶æ›¿æ¢ä¸Šæ¬¡æŒä¹…åŒ–å¥½çš„æ–‡ä»¶ã€‚æ­£æ˜¯è¿™ç§ç‰¹æ€§ï¼Œè®©æˆ‘ä»¬å¯ä»¥éšæ—¶æ¥è¿›è¡Œå¤‡ä»½ï¼Œå› ä¸ºå¿«ç…§æ–‡ä»¶æ€»æ˜¯å®Œæ•´å¯ç”¨çš„ã€‚

RDBä¼˜ç‚¹ï¼š

*   RDBæ˜¯ä¸€ä¸ªéå¸¸ç´§å‡‘çš„æ–‡ä»¶,å®ƒä¿å­˜äº†æŸä¸ªæ—¶é—´ç‚¹å¾—æ•°æ®é›†,éå¸¸é€‚ç”¨äºæ•°æ®é›†çš„å¤‡ä»½,æ¯”å¦‚ä½ å¯ä»¥åœ¨æ¯ä¸ªå°æ—¶æŠ¥ä¿å­˜ä¸€ä¸‹è¿‡å»24å°æ—¶å†…çš„æ•°æ®,åŒæ—¶æ¯å¤©ä¿å­˜è¿‡å»30å¤©çš„æ•°æ®,è¿™æ ·å³ä½¿å‡ºäº†é—®é¢˜ä½ ä¹Ÿå¯ä»¥æ ¹æ®éœ€æ±‚æ¢å¤åˆ°ä¸åŒç‰ˆæœ¬çš„æ•°æ®é›†.
*   RDBæ˜¯ä¸€ä¸ªç´§å‡‘çš„å•ä¸€æ–‡ä»¶,å¾ˆæ–¹ä¾¿ä¼ é€åˆ°å¦ä¸€ä¸ªè¿œç«¯æ•°æ®ä¸­å¿ƒæˆ–è€…äºšé©¬é€Šçš„S3ï¼ˆå¯èƒ½åŠ å¯†ï¼‰ï¼Œéå¸¸é€‚ç”¨äºç¾éš¾æ¢å¤.
*   RDBåœ¨ä¿å­˜RDBæ–‡ä»¶æ—¶çˆ¶è¿›ç¨‹å”¯ä¸€éœ€è¦åšçš„å°±æ˜¯forkå‡ºä¸€ä¸ªå­è¿›ç¨‹,æ¥ä¸‹æ¥çš„å·¥ä½œå…¨éƒ¨ç”±å­è¿›ç¨‹æ¥åšï¼Œçˆ¶è¿›ç¨‹ä¸éœ€è¦å†åšå…¶ä»–IOæ“ä½œï¼Œæ‰€ä»¥RDBæŒä¹…åŒ–æ–¹å¼å¯ä»¥æœ€å¤§åŒ–redisçš„æ€§èƒ½.

RDBç¼ºç‚¹ï¼š

*   å¦‚æœä½ å¸Œæœ›åœ¨redisæ„å¤–åœæ­¢å·¥ä½œï¼ˆä¾‹å¦‚ç”µæºä¸­æ–­ï¼‰çš„æƒ…å†µä¸‹ä¸¢å¤±çš„æ•°æ®æœ€å°‘çš„è¯ï¼Œé‚£ä¹ˆRDBä¸é€‚åˆä½ .è™½ç„¶ä½ å¯ä»¥é…ç½®ä¸åŒçš„saveæ—¶é—´ç‚¹(ä¾‹å¦‚æ¯éš”5åˆ†é’Ÿå¹¶ä¸”å¯¹æ•°æ®é›†æœ‰100ä¸ªå†™çš„æ“ä½œ),æ˜¯Redisè¦å®Œæ•´çš„ä¿å­˜æ•´ä¸ªæ•°æ®é›†æ˜¯ä¸€ä¸ªæ¯”è¾ƒç¹é‡çš„å·¥ä½œ,ä½ é€šå¸¸ä¼šæ¯éš”5åˆ†é’Ÿæˆ–è€…æ›´ä¹…åšä¸€æ¬¡å®Œæ•´çš„ä¿å­˜,ä¸‡ä¸€åœ¨Redisæ„å¤–å®•æœº,ä½ å¯èƒ½ä¼šä¸¢å¤±å‡ åˆ†é’Ÿçš„æ•°æ®.
*   RDB éœ€è¦ç»å¸¸forkå­è¿›ç¨‹æ¥ä¿å­˜æ•°æ®é›†åˆ°ç¡¬ç›˜ä¸Š,å½“æ•°æ®é›†æ¯”è¾ƒå¤§çš„æ—¶å€™,forkçš„è¿‡ç¨‹æ˜¯éå¸¸è€—æ—¶çš„,å¯èƒ½ä¼šå¯¼è‡´Redisåœ¨ä¸€äº›æ¯«ç§’çº§å†…ä¸èƒ½å“åº”å®¢æˆ·ç«¯çš„è¯·æ±‚.å¦‚æœæ•°æ®é›†å·¨å¤§å¹¶ä¸”CPUæ€§èƒ½ä¸æ˜¯å¾ˆå¥½çš„æƒ…å†µä¸‹,è¿™ç§æƒ…å†µä¼šæŒç»­1ç§’,AOFä¹Ÿéœ€è¦fork,ä½†æ˜¯ä½ å¯ä»¥è°ƒèŠ‚é‡å†™æ—¥å¿—æ–‡ä»¶çš„é¢‘ç‡æ¥æé«˜æ•°æ®é›†çš„è€ä¹…åº¦.

**AOFæŒä¹…åŒ–**

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e3095bb4e0c749db9cff96413ade43a5~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=2715&h=1140&s=481457&e=png&b=ffffff)

AOFæ–¹å¼æ˜¯å°†æ‰§è¡Œè¿‡çš„å†™æŒ‡ä»¤è®°å½•ä¸‹æ¥ï¼Œåœ¨æ•°æ®æ¢å¤æ—¶æŒ‰ç…§ä»å‰åˆ°åçš„é¡ºåºå†å°†æŒ‡ä»¤éƒ½æ‰§è¡Œä¸€éã€‚

> å®ç°æ–¹å¼ï¼šæˆ‘ä»¬é€šè¿‡é…ç½®Redis.conf ä¸­çš„appendonly yes å°±å¯ä»¥æ‰“å¼€AOFåŠŸèƒ½ã€‚å¦‚æœæœ‰å†™æ“ä½œ(å¦‚SET ç­‰)ï¼ŒRedis å°±ä¼šè¢«è¿½åŠ åˆ°AOF æ–‡ä»¶çš„æœ«å°¾ã€‚ AOF æŒä¹…åŒ–çš„æ–¹å¼ï¼š é»˜è®¤çš„AOF æŒä¹…åŒ–ç­–ç•¥æ˜¯æ¯ç§’é’Ÿfsync ä¸€æ¬¡(fsyncæ˜¯æŒ‡æŠŠç¼“å­˜ä¸­çš„å†™æŒ‡ä»¤è®°å½•åˆ°ç£ç›˜ä¸­)ï¼Œå› ä¸ºåœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒRedis ä»ç„¶å¯ä»¥ä¿æŒå¾ˆå¥½çš„å¤„ç†æ€§èƒ½ï¼Œå³ä½¿Redis æ•…éšœï¼Œä¹Ÿåªä¼šä¸¢å¤±æœ€è¿‘1 ç§’é’Ÿçš„æ•°æ®ã€‚ Â Â å¦‚æœåœ¨è¿½åŠ æ—¥å¿—æ—¶ï¼Œæ°å¥½é‡åˆ°ç£ç›˜ç©ºé—´æ»¡æˆ–æ–­ç”µç­‰æƒ…å†µå¯¼è‡´æ—¥å¿—å†™å…¥ä¸å®Œæ•´ï¼Œä¹Ÿæ²¡æœ‰å…³ç³»ï¼ŒRedis æä¾›äº†**Redis-check-aof**å·¥å…·ï¼Œå¯ä»¥ç”¨æ¥è¿›è¡Œæ—¥å¿—ä¿®å¤ã€‚å› ä¸ºé‡‡ç”¨äº†è¿½åŠ æ–¹å¼ï¼Œå¦‚æœä¸åšä»»ä½•å¤„ç†çš„è¯ï¼ŒAOF æ–‡ä»¶ä¼šå˜å¾—è¶Šæ¥è¶Šå¤§ï¼Œä¸ºæ­¤ï¼ŒRedis æä¾›äº†AOF æ–‡ä»¶é‡å†™(rewrite)æœºåˆ¶ï¼Œå³å½“AOF æ–‡ä»¶çš„å¤§å°è¶…è¿‡æ‰€è®¾å®šçš„é˜ˆå€¼æ—¶ï¼ŒRedis å°±ä¼šå¯åŠ¨AOF æ–‡ä»¶çš„å†…å®¹å‹ç¼©ï¼Œåªä¿ç•™å¯ä»¥æ¢å¤æ•°æ®çš„æœ€å°æŒ‡ä»¤é›†ã€‚ä¸¾ä¸ªä¾‹å­æˆ–è®¸æ›´å½¢è±¡ï¼Œå‡å¦‚æˆ‘ä»¬è°ƒç”¨äº†100 æ¬¡INCR æŒ‡ä»¤ï¼Œåœ¨AOF æ–‡ä»¶ä¸­å°±è¦å­˜å‚¨100 æ¡æŒ‡ä»¤ï¼Œä½†è¿™æ˜æ˜¾æ˜¯å¾ˆä½æ•ˆçš„ï¼Œå®Œå…¨å¯ä»¥æŠŠè¿™100æ¡æŒ‡ä»¤åˆå¹¶æˆä¸€æ¡SET æŒ‡ä»¤ï¼Œè¿™å°±æ˜¯é‡å†™æœºåˆ¶çš„åŸç†ã€‚

AOF ä¼˜ç‚¹ï¼šæˆ‘ä»¬é€šè¿‡ä¸€ä¸ªåœºæ™¯å†ç°æ¥è¯´æ˜ã€‚æŸåŒå­¦åœ¨æ“ä½œRedis æ—¶ï¼Œä¸å°å¿ƒæ‰§è¡Œäº†FLUSHALLï¼Œå¯¼è‡´Redis å†…å­˜ä¸­çš„æ•°æ®å…¨éƒ¨è¢«æ¸…ç©ºäº†ï¼Œè¿™æ˜¯å¾ˆæ‚²å‰§çš„äº‹æƒ…ã€‚ä¸è¿‡è¿™ä¹Ÿä¸æ˜¯ä¸–ç•Œæœ«æ—¥ï¼Œåªè¦Redis é…ç½®äº†AOF æŒä¹…åŒ–æ–¹å¼ï¼Œä¸”AOFæ–‡ä»¶è¿˜æ²¡æœ‰è¢«é‡å†™(rewrite)ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç”¨æœ€å¿«çš„é€Ÿåº¦æš‚åœRedis å¹¶ç¼–è¾‘AOFæ–‡ä»¶ï¼Œå°†æœ€åä¸€è¡Œçš„FLUSHALL å‘½ä»¤åˆ é™¤ï¼Œç„¶åé‡å¯Redisï¼Œå°±å¯ä»¥æ¢å¤Redisçš„æ‰€æœ‰æ•°æ®åˆ°FLUSHALL ä¹‹å‰çš„çŠ¶æ€äº†ã€‚æ˜¯ä¸æ˜¯å¾ˆç¥å¥‡ï¼Œè¿™å°±æ˜¯AOF æŒä¹…åŒ–æ–¹å¼çš„å¥½å¤„ä¹‹ä¸€ã€‚ä½†æ˜¯å¦‚æœAOF æ–‡ä»¶å·²ç»è¢«é‡å†™äº†ï¼Œé‚£å°±æ— æ³•é€šè¿‡è¿™ç§æ–¹æ³•æ¥æ¢å¤æ•°æ®äº†ã€‚ AOFç¼ºç‚¹ï¼šæ¯”å¦‚åœ¨åŒæ ·æ•°æ®è§„æ¨¡çš„æƒ…å†µä¸‹ï¼ŒAOFæ–‡ä»¶è¦æ¯”RDBæ–‡ä»¶çš„ä½“ç§¯å¤§ã€‚è€Œä¸”ï¼ŒAOF æ–¹å¼çš„æ¢å¤é€Ÿåº¦ä¹Ÿè¦æ…¢äºRDB æ–¹å¼ã€‚ ![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/79553e17946141e19121ff41744cc3d7~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1137&h=413&s=41404&e=webp&b=d9d9d9)

ä¼ä¸šçº§çš„æŒä¹…åŒ–çš„é…ç½®ç­–ç•¥

RDB å’Œ AOF æ˜¯ Redis å†…éƒ¨çš„ä¸¤ç§æ•°æ®æŒä¹…åŒ–ç­–ç•¥ï¼Œè¿™æ˜¯ä¸¤ç§ä¸åŒçš„æŒä¹…åŒ–ç­–ç•¥ï¼Œä¸€ç§æ˜¯åŸºäºå†…å­˜å¿«ç…§ï¼Œä¸€ç§æ˜¯åŸºäºæ“ä½œæ—¥å¿—ã€‚

åœ¨ä¼ä¸šä¸­ï¼ŒRDBçš„ç”Ÿæˆç­–ç•¥ï¼Œç”¨é»˜è®¤çš„ä¹Ÿå·®ä¸å¤š

save 60 10000ï¼šå¦‚æœä½ å¸Œæœ›å°½å¯èƒ½ç¡®ä¿è¯´ï¼ŒRDBæœ€å¤šä¸¢1åˆ†é’Ÿçš„æ•°æ®ï¼Œé‚£ä¹ˆå°½é‡å°±æ˜¯æ¯éš”1åˆ†é’Ÿéƒ½ç”Ÿæˆä¸€ä¸ªå¿«ç…§ï¼Œä½å³°æœŸï¼Œæ•°æ®é‡å¾ˆå°‘ï¼Œä¹Ÿæ²¡å¿…è¦

å…·ä½“æ˜¯10000->ç”ŸæˆRDBï¼Œ1000->RDBï¼Œè¿™ä¸ªç”Ÿæˆrdbæ“ä½œçš„é˜ˆå€¼å¤§å°ï¼Œè¿™ä¸ªæ ¹æ®ä½ è‡ªå·±çš„åº”ç”¨å’Œä¸šåŠ¡çš„æ•°æ®é‡ï¼Œä½ è‡ªå·±å»å†³å®š

AOFä¸€å®šè¦æ‰“å¼€ï¼Œè®¾ç½®appendsync = everysec

auto-aof-rewrite-percentage 100: å°±æ˜¯å½“å‰AOFå¤§å°è†¨èƒ€åˆ°è¶…è¿‡ä¸Šæ¬¡100%ï¼Œä¸Šæ¬¡çš„ä¸¤å€

auto-aof-rewrite-min-size 64mb: æ ¹æ®ä½ çš„æ•°æ®é‡æ¥å®šï¼Œ16mbï¼Œ32mb

**redisæ•°æ®å¤‡ä»½æ¢å¤**

[redisæ•°æ®å¤‡ä»½æ¢å¤å‚è€ƒåœ°å€](https://link.juejin.cn/?target=https%3A%2F%2Fblog.csdn.net%2Fweixin_42555019%2Farticle%2Fdetails%2F100118260%3Fops_request_misc%3D%25257B%252522request%25255Fid%252522%25253A%252522170174114216800197047783%252522%25252C%252522scm%252522%25253A%25252220140713.130102334.pc%25255Fall.%252522%25257D%26request_id%3D170174114216800197047783%26biz_id%3D0%26utm_medium%3Ddistribute.pc_search_result.none-task-blog-2~all~first_rank_ecpm_v1~hot_rank-10-100118260-null-null.142%255Ev96%255Epc_search_result_base6%26utm_term%3Dredis%25E5%25A4%2587%25E4%25BB%25BD%26spm%3D1018.2226.3001.4187 "https://blog.csdn.net/weixin_42555019/article/details/100118260?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522170174114216800197047783%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fall.%2522%257D&request_id=170174114216800197047783&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~first_rank_ecpm_v1~hot_rank-10-100118260-null-null.142%5Ev96%5Epc_search_result_base6&utm_term=redis%E5%A4%87%E4%BB%BD&spm=1018.2226.3001.4187")

[redisæ•°æ®è¿ç§»å‚è€ƒåœ°å€](https://link.juejin.cn/?target=https%3A%2F%2Fblog.csdn.net%2Fweixin_44566795%2Farticle%2Fdetails%2F130562562 "https://blog.csdn.net/weixin_44566795/article/details/130562562")

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2cccb554d28b4e60bf844e66de79e7a6~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1080&h=518&s=252291&e=png&b=fefdfd)

Â Â Â Â å­¦ä¹ ä¸€é—¨æŠ€æœ¯ï¼Œå…³é”®æ˜¯ä¸ºæˆ‘æ‰€ç”¨ï¼Œèƒ½è¿‡é€šè¿‡æŠ€æœ¯é©±åŠ¨ä¸šåŠ¡ï¼Œæœ‰å®é™…çš„ä¸šåŠ¡äº§å‡ºï¼Œæé«˜ä¼ä¸šå˜ç°çš„èƒ½åŠ›æˆ–æ•´ä¸ªç”Ÿäº§æµç¨‹çš„æ•ˆç‡ï¼Œè¿™æ˜¯æ¯ä¸ªæŠ€æœ¯äººå¿…é¡»è½å®çš„ç†å¿µï¼

Â Â Â Â ä½œä¸ºå²ä¸Šæœ€å¤§çš„Redisé›†ç¾¤ï¼Œæœ‰å¿…è¦é€è¿‡æ–°æµªå¾®åšè¿™å®¶ä¼ä¸šæ¥çœ‹redisåœ¨ä¼ä¸šä¸­çš„ä½¿ç”¨å€Ÿé‰´ï¼

> æ–°æµªå¾®åšç›®å‰ä½¿ç”¨çš„98%éƒ½æ˜¯æŒä¹…åŒ–çš„åº”ç”¨ï¼Œ2%çš„æ˜¯ç¼“å­˜ï¼Œç”¨åˆ°äº†600+æœåŠ¡å™¨ Redisä¸­æŒä¹…åŒ–çš„åº”ç”¨å’ŒéæŒä¹…åŒ–çš„æ–¹å¼ä¸ä¼šå·®åˆ«å¾ˆå¤§ï¼š éæŒä¹…åŒ–çš„ä¸º8-9ä¸‡tpsï¼Œé‚£ä¹ˆæŒä¹…åŒ–åœ¨7-8ä¸‡tpså·¦å³ï¼› å½“ä½¿ç”¨æŒä¹…åŒ–æ—¶ï¼Œéœ€è¦è€ƒè™‘åˆ°æŒä¹…åŒ–å’Œå†™æ€§èƒ½çš„é…æ¯”ï¼Œä¹Ÿå°±æ˜¯è¦è€ƒè™‘redisä½¿ç”¨çš„å†…å­˜å¤§å°å’Œç¡¬ç›˜å†™çš„é€Ÿç‡çš„æ¯”ä¾‹è®¡ç®—ï¼›

ğŸ‰ 5.1 ä½¿ç”¨å†ç¨‹
-----------

2009å¹´, ä½¿ç”¨memcache(ç”¨äºéæŒä¹…åŒ–å†…å®¹), memcacheDB(ç”¨äºæŒä¹…åŒ–+è®¡æ•°), memcacheDBæ˜¯æ–°æµªåœ¨memcacheçš„åŸºç¡€ä¸Šï¼Œä½¿ç”¨BerkeleyDBä½œä¸ºæ•°æ®æŒä¹…åŒ–çš„å­˜å‚¨å®ç°ï¼›

**é¢ä¸´çš„é—®é¢˜**

> æ•°æ®ç»“æ„(Data Structure)éœ€æ±‚è¶Šæ¥è¶Šå¤š, ä½†memcacheä¸­æ²¡æœ‰, å½±å“å¼€å‘æ•ˆç‡æ€§èƒ½éœ€æ±‚, éšç€è¯»æ“ä½œçš„é‡çš„ä¸Šå‡éœ€è¦è§£å†³ã€‚ ç»å†çš„è¿‡ç¨‹æœ‰: æ•°æ®åº“è¯»å†™åˆ†ç¦»(M/S)-->æ•°æ®åº“ä½¿ç”¨å¤šä¸ªSlave-->å¢åŠ Cache (memcache)-->è½¬åˆ°Redisè§£å†³å†™çš„é—®é¢˜ï¼šæ°´å¹³æ‹†åˆ†ï¼Œå¯¹è¡¨çš„æ‹†åˆ†ï¼Œå°†æœ‰çš„ç”¨æˆ·æ”¾åœ¨è¿™ä¸ªè¡¨ï¼Œæœ‰çš„ç”¨æˆ·æ”¾åœ¨å¦å¤–ä¸€ä¸ªè¡¨ï¼› å¯é æ€§éœ€æ±‚: Cacheçš„"é›ªå´©"é—®é¢˜è®©äººçº ç»“ Cacheé¢ä¸´ç€å¿«é€Ÿæ¢å¤çš„æŒ‘æˆ˜ å¼€å‘æˆæœ¬éœ€æ±‚: Cacheå’ŒDBçš„ä¸€è‡´æ€§ç»´æŠ¤æˆæœ¬è¶Šæ¥è¶Šé«˜(å…ˆæ¸…ç†DB, å†æ¸…ç†ç¼“å­˜, ä¸è¡Œå•Š, å¤ªæ…¢äº†!) å¼€å‘éœ€è¦è·Ÿä¸Šä¸æ–­æ¶Œå…¥çš„äº§å“éœ€æ±‚: ç¡¬ä»¶æˆæœ¬æœ€è´µçš„å°±æ˜¯æ•°æ®åº“å±‚é¢çš„æœºå™¨ï¼ŒåŸºæœ¬ä¸Šæ¯”å‰ç«¯çš„æœºå™¨è¦è´µå‡ å€ï¼Œä¸»è¦æ˜¯IOå¯†é›†å‹ï¼Œå¾ˆè€—ç¡¬ä»¶ï¼› ç»´æŠ¤æ€§å¤æ‚: ä¸€è‡´æ€§ç»´æŠ¤æˆæœ¬è¶Šæ¥è¶Šé«˜ï¼› BerkeleyDBä½¿ç”¨Bæ ‘ï¼Œä¼šä¸€ç›´å†™æ–°çš„ï¼Œå†…éƒ¨ä¸ä¼šæœ‰æ–‡ä»¶é‡æ–°ç»„ç»‡ï¼›è¿™æ ·ä¼šå¯¼è‡´æ–‡ä»¶è¶Šæ¥è¶Šå¤§ï¼›å¤§çš„æ—¶å€™éœ€è¦è¿›è¡Œæ–‡ä»¶å½’æ¡£ï¼Œå½’æ¡£çš„æ“ä½œè¦å®šæœŸåšï¼› è¿™æ ·ï¼Œå°±éœ€è¦æœ‰ä¸€å®šçš„down timeï¼›

ğŸ¥ 5.2 å¯»æ‰¾å¼€æºè½¯ä»¶çš„æ–¹å¼åŠè¯„åˆ¤æ ‡å‡†
---------------------

*   å¯¹äºå¼€æºè½¯ä»¶ï¼Œé¦–å…ˆçœ‹å…¶èƒ½åšä»€ä¹ˆï¼Œä½†æ›´å¤šçš„éœ€è¦å…³æ³¨å®ƒä¸èƒ½åšä»€ä¹ˆï¼Œå®ƒä¼šæœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿ
*   ä¸Šå‡åˆ°ä¸€å®šè§„æ¨¡åï¼Œå¯èƒ½ä¼šå‡ºç°ä»€ä¹ˆé—®é¢˜ï¼Œæ˜¯å¦èƒ½æ¥å—ï¼Ÿ
*   google codeä¸Š, å›½å¤–è®ºå›æ‰¾ææ–™(å›½å†…æ¯”å›½å¤–æŠ€æœ¯æ°´å¹³æ»å5å¹´ï¼‰
*   è§‚å¯Ÿä½œè€…ä¸ªäººçš„ä»£ç æ°´å¹³

ğŸ“ 5.3 ä¸šåŠ¡ä½¿ç”¨æ–¹å¼
-------------

*   hash sets: å…³æ³¨åˆ—è¡¨, ç²‰ä¸åˆ—è¡¨, åŒå‘å…³æ³¨åˆ—è¡¨(key-value(field), æ’åº)
*   string(counter): å¾®åšæ•°, ç²‰ä¸æ•°, ...(é¿å…äº†select count(*) from ...)
*   sort sets(è‡ªåŠ¨æ’åº): TopN, çƒ­é—¨å¾®åšç­‰, è‡ªåŠ¨æ’åº
*   lists(queue): push/subæé†’,...

ä¸Šè¿°å››ç§, ä»ç²¾ç»†åŒ–æ§åˆ¶æ–¹é¢: hash setså’Œstring(counter)æ¨èä½¿ç”¨, sort setså’Œlists(queue)ä¸æ¨èä½¿ç”¨ è¿˜å¯é€šè¿‡äºŒæ¬¡å¼€å‘ï¼Œè¿›è¡Œç²¾ç®€ã€‚æ¯”å¦‚: å­˜å‚¨å­—ç¬¦æ”¹ä¸ºå­˜å‚¨æ•´å½¢, 16äº¿æ•°æ®, åªéœ€è¦16Gå†…å­˜ å­˜å‚¨ç±»å‹ä¿å­˜åœ¨3ç§ä»¥å†…ï¼Œå»ºè®®ä¸è¦è¶…è¿‡3ç§ï¼› å°†memcache +myaql æ›¿æ¢ä¸ºRedisï¼š Redisä½œä¸ºå­˜å‚¨å¹¶æä¾›æŸ¥è¯¢ï¼Œåå°ä¸å†ä½¿ç”¨mysqlï¼Œè§£å†³æ•°æ®å¤šä»½ä¹‹é—´çš„ä¸€è‡´æ€§é—®é¢˜ï¼›

### ğŸ 5.3.1 List

**å¾®åšå’Œå¾®ä¿¡å…¬ä¼—å·æ¶ˆæ¯æµ**

```powershell
LPUSH msg:{id} 10086

```

**æŸ¥çœ‹æœ€æ–°çš„å¾®åšæ¶ˆæ¯**

```powershell
//LRANGE:è¿”å›åˆ—è¡¨keyä¸­æŒ‡å®šåŒºé—´å†…çš„å…ƒç´ ,åŒºé—´ä»¥åç§»é‡startå’ŒstopæŒ‡å®š
LRANGE  msg:{id} 0 5

```

**å¾®ä¿¡ã€å¾®åšåœ¨çº¿ç”¨æˆ·æŠ½å¥–**

```sql
//æ€è·¯
1)ç‚¹å‡»å‚ä¸æŠ½å¥–åŠ å…¥é›†åˆ
SADD key {userID}
2)æŸ¥çœ‹å‚ä¸æŠ½å¥–æ‰€æœ‰ç”¨æˆ·
SMEMBERS key
3)æŠ½countåä¸­å¥–è€…
å¦‚æœå¸Œæœ›ä¸­å¥–ç”¨æˆ·ä¾ç„¶ä¿ç•™åœ¨æŠ½å¥–æ± é‡Œé¢
SRANDMENMBER key [count]
SRANDMENMBER ä»é›†åˆkeyä¸­é€‰å‡ºcountä¸ªå…ƒç´ ,å…ƒç´ ä¸ä»keyä¸­åˆ é™¤
å¦‚æœä¸å¸Œæœ›ä¸­å¥–ç”¨æˆ·ä¾ç„¶ä¿ç•™åœ¨æŠ½å¥–æ± é‡Œé¢
SPOP key [count]
SPOPä»é›†åˆkeyä¸­é€‰å‡ºcountä¸ªå…ƒç´ ,å…ƒç´ ä»keyä¸­åˆ é™¤

```

**å¾®ä¿¡ã€å¾®åšã€æŠ–éŸ³ç‚¹èµã€æ”¶è—æ ‡ç­¾**

```sql
//æ€è·¯
1)æŠ–éŸ³å¤§Vè§†é¢‘ç‚¹èµé‡
SADD like:{messageId}  {userId}
2)å–æ¶ˆç‚¹èµ
SREM like:{messageId} {userId}
ç§»é™¤é›†åˆ key ä¸­çš„ä¸€ä¸ªæˆ–å¤šä¸ª member å…ƒç´ ï¼Œä¸å­˜åœ¨çš„ member å…ƒç´ ä¼šè¢«å¿½ç•¥
3)æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ç‚¹è¿‡èµ
SISMEMBER like:{messageId} {userId}
4)è·å–ç‚¹èµçš„ç”¨æˆ·åˆ—è¡¨
SISMEMBER like:{messageId}
5)è·å–ç‚¹èµç”¨æˆ·æ•°
è¿”å›é›†åˆ key çš„åŸºæ•°(é›†åˆä¸­å…ƒç´ çš„æ•°é‡)
SCARD like:{messageId}

```

**å¾®åšã€QQå…±åŒå…³æ³¨çš„äºº,æˆ‘å…³æ³¨çš„äººä¹Ÿå…³æ³¨ä»–,å¯èƒ½è®¤è¯†çš„äºº**

```sql
//æ€è·¯
å…±åŒå…³æ³¨çš„äºº:
//ä¸¤ä¸ªé›†åˆçš„äº¤é›†
SINTER simaSet yanguoSet
æˆ‘å…³æ³¨çš„äººä¹Ÿå…³æ³¨ä»–
//æˆ‘å…³æ³¨çš„äººåœ¨ä»–çš„é›†åˆé‡Œé¢,å¯ä»¥è¿ç”¨SISMENBER
SISMENBER simaSet yanguo
æˆ‘å¯èƒ½è®¤è¯†çš„äºº
//ä»–å…³æ³¨çš„äºº,ä¸åœ¨æˆ‘çš„é›†åˆé‡Œé¢,ä½†æ˜¯åœ¨æˆ‘çš„æœ‹å‹é›†åˆé‡Œé¢
SDIFF simaSet yanguoSet

```

### ğŸ… 5.3.2 Zset

**å¾®åšçƒ­æœã€æ’è¡Œæ¦œ**

```sql
//æ€è·¯
1)çƒ­æœ
//æ–°é—»ç‚¹å‡»é‡
ZINCRBY HOTNEWS:20191115 1 æå°ç’ç¦»å©š
ä¸ºæœ‰åºé›†åˆkeyä¸­å…ƒç´ memberçš„åˆ†å€¼åŠ ä¸Šincrement
2)å±•ç¤ºå½“æ—¥æ’è¡Œç‰ˆå‰å
ZREVRANGE hotNews:20191115 0 10 WITHSCORES
ZREVRANGEå€’åºè·å–æœ‰åºé›†åˆkeyä¸­startä¸‹æ ‡åˆ°stopä¸‹æ ‡çš„å…ƒç´ 
3)ä¸ƒæ—¥æœç´¢æ¦œå•è®¡ç®—
ZUNIONSTORE hotNews:20190722 7
å¹¶é›†è®¡ç®—
4)å±•ç¤ºä¸ƒæ—¥æ’è¡Œå‰å
ZREVRANGE hotNews:20190716-20190722 0 10 WITHSCORES
äº¤é›†è®¡ç®—

```

### ğŸ¥’ 5.3.3 Geo

**é™„è¿‘çš„äºº**

```sql
//æ€è·¯
å¾®åšã€å¾®ä¿¡ã€é»˜é»˜<é™„è¿‘çš„äºº>
æ»´æ»´æ‰“è½¦ã€å“ˆå•°å•è½¦ã€ç¾å›¢å•è½¦<é™„è¿‘çš„è½¦>
ç¾å›¢å’Œé¥¿äº†å—<é™„è¿‘çš„é¤é¦†>

åŸºäºåœ°ç†ä½ç½®
æ¯”å¦‚GEORADIUS
redis> GEOADD Sicily 13.361389 38.115556 "Palermo" 15.087269 37.502669 "Catania"
(integer) 2

redis> GEORADIUS Sicily 15 37 200 km WITHDIST
1) 1) "Palermo"
   2) "190.4424"
2) 1) "Catania"
   2) "56.4413"

redis> GEORADIUS Sicily 15 37 200 km WITHCOORD
1) 1) "Palermo"
   2) 1) "13.361389338970184"
      2) "38.115556395496299"
2) 1) "Catania"
   2) 1) "15.087267458438873"
      2) "37.50266842333162"

redis> GEORADIUS Sicily 15 37 200 km WITHDIST WITHCOORD
1) 1) "Palermo"
   2) "190.4424"
   3) 1) "13.361389338970184"
      2) "38.115556395496299"
2) 1) "Catania"
   2) "56.4413"
   3) 1) "15.087267458438873"
      2) "37.50266842333162"

```

### ğŸ’ 5.3.4 String

**å¾®ä¿¡å…¬ä¼—å·ä¸­æ–‡ç« é˜…è¯»é‡ã€æŠ–éŸ³ä¸­çš„åŸå¸‚è®¿é—®é‡**

```sql
Redisæä¾›äº†åŸºäºåŸå­çš„åŠ å‡æ“ä½œ,
è¿™é‡Œé¢æˆ‘ä»¬å¯ä»¥ç”¨è®¡æ•°å™¨åŠŸèƒ½,
è¿ç”¨INCRå¯¹feildè¿›è¡ŒåŠ åŠ æ“ä½œç»Ÿè®¡æ•°æ®, 
INCR  article:readcount:{articleId}.

```

ğŸŒ½ 5.4 å…¶ä»–é«˜é¢‘é€šç”¨åœºæ™¯
---------------

**ä¼šè¯ç¼“å­˜ï¼ˆSession Cacheï¼‰or å…¨é¡µç¼“å­˜ï¼ˆFPCï¼‰ or æ•°æ®ç¼“å­˜ï¼ˆData Cacheï¼‰** ![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/792a7d560f56422683da7fe86e497251~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=803&h=500&s=108403&e=png&b=fefefe)

> Â Â Redisæ•°æ®åº“æ˜¯ä¸€ç§åŸºäºç¼“å­˜çš„æ•°æ®åº“ï¼Œé€šè¿‡ç¼“å­˜æ¥æå‡è®¿é—®é€Ÿåº¦ã€‚ Â Â å½“æˆ‘ä»¬è®¿é—®æŸä¸ªç½‘ç«™æ—¶ï¼Œç¬¬ä¸€ä¸ªè®¿é—®è€…å‘æœåŠ¡å™¨å‘èµ·è¯·æ±‚ï¼ŒæœåŠ¡å™¨è¿”å›ä¸€äº›é™æ€æ–‡ä»¶ã€‚ Â Â å¦‚æœæŸäº›é™æ€æ–‡ä»¶çš„å†…å®¹ä¸ç»å¸¸å˜åŒ–ï¼Œå°±å¯ä»¥å°†å®ƒä»¬å­˜å‚¨åˆ°Redisä¸­ï¼Œä»¥ä¾¿ä¸‹ä¸€æ¬¡è®¿é—®æ—¶ç›´æ¥ä»Redisä¸­è¿”å›ï¼ŒèŠ‚çœæŸ¥æ‰¾æ—¶é—´ã€‚å¦‚æœRedisä¸­æ²¡æœ‰éœ€è¦çš„æ•°æ®ï¼Œå°±åœ¨æ–‡ä»¶ä¸­æŸ¥æ‰¾å¹¶è¿”å›æ•°æ®ï¼ŒåŒæ—¶å°†æ•°æ®å­˜å‚¨åˆ°Redisä¸­ï¼Œä»¥ä¾¿ä¸‹ä¸€ä¸ªäººè®¿é—®æ—¶å¯ä»¥å¿«é€Ÿè¿”å›ã€‚ Â Â ç”±äºRedisåŸºäºå†…å­˜å­˜å‚¨ï¼Œå­˜å‚¨ç©ºé—´æœ‰é™ï¼Œå› æ­¤éœ€è¦å¯¹æ•°æ®è¿›è¡ŒåŒºåˆ†å’Œè®¾ç½®å­˜å‚¨æ—¶é—´ï¼Œé¿å…å­˜å‚¨æ»¡åæ— æ³•ç»§ç»­å­˜å‚¨ã€‚å¯¹äºè®¿é—®é¢‘ç‡é«˜çš„æ•°æ®ï¼Œå…¶å­˜å‚¨æ—¶é—´ä¼šè¢«ä¸æ–­æ›´æ–°å»¶é•¿ï¼Œè€Œå¯¹äºè®¿é—®é¢‘ç‡ä½çš„æ•°æ®ï¼Œåˆ™ä¼šå› ä¸ºé•¿æ—¶é—´æœªè¢«è®¿é—®è€Œè‡ªåŠ¨åˆ é™¤ã€‚è¿™ç§æ•°æ®å­˜å‚¨æ–¹å¼éå¸¸å¸¸è§ï¼Œä½†éœ€è¦æ ¹æ®å®é™…æƒ…å†µè¿›è¡Œè®¾ç½®å’Œè°ƒæ•´ã€‚

**bitMap(å¤§æ•°æ®å¤„ç†ï¼‰**

Â Â æºäºredisç‰¹æ®Šçš„æ•°æ®ç»“æ„ä½å›¾ï¼ˆbitmapï¼‰ï¼Œç”¨äºæ•°æ®é‡ä¸Šäº¿çš„åœºæ™¯ä¸‹ï¼Œä¾‹å¦‚å‡ äº¿ç”¨æˆ·ç³»ç»Ÿçš„ç­¾åˆ°ï¼Œå»é‡ç™»å½•æ¬¡æ•°ç»Ÿè®¡ï¼ŒæŸç”¨æˆ·æ˜¯å¦åœ¨çº¿çŠ¶æ€ç­‰ç­‰ã€‚è…¾è®¯10äº¿ç”¨æˆ·ï¼Œè¦å‡ ä¸ªæ¯«ç§’å†…æŸ¥è¯¢åˆ°æŸä¸ªç”¨æˆ·æ˜¯å¦åœ¨çº¿ï¼Œèƒ½æ€ä¹ˆåšï¼Ÿåƒä¸‡åˆ«è¯´ç»™æ¯ä¸ªç”¨æˆ·å»ºç«‹ä¸€ä¸ªkeyï¼Œç„¶åæŒ¨ä¸ªè®°ï¼ˆä½ å¯ä»¥ç®—ä¸€ä¸‹éœ€è¦çš„å†…å­˜ä¼šå¾ˆææ€–ï¼Œè€Œä¸”è¿™ç§ç±»ä¼¼çš„éœ€æ±‚å¾ˆå¤šã€‚è¿™é‡Œè¦ç”¨åˆ°ä½æ“ä½œâ€”â€”ä½¿ç”¨setbitã€getbitã€bitcountå‘½ä»¤ã€‚åŸç†æ˜¯ï¼š Â Â rediså†…æ„å»ºä¸€ä¸ªè¶³å¤Ÿé•¿çš„æ•°ç»„ï¼Œæ¯ä¸ªæ•°ç»„å…ƒç´ åªèƒ½æ˜¯0å’Œ1ä¸¤ä¸ªå€¼ï¼Œç„¶åè¿™ä¸ªæ•°ç»„çš„ä¸‹æ ‡indexç”¨æ¥è¡¨ç¤ºç”¨æˆ·idï¼ˆå¿…é¡»æ˜¯æ•°å­—å“ˆï¼‰ï¼Œé‚£ä¹ˆå¾ˆæ˜¾ç„¶ï¼Œè¿™ä¸ªå‡ äº¿é•¿çš„å¤§æ•°ç»„å°±èƒ½é€šè¿‡ä¸‹æ ‡å’Œå…ƒç´ å€¼ï¼ˆ0å’Œ1ï¼‰æ¥æ„å»ºä¸€ä¸ªè®°å¿†ç³»ç»Ÿã€‚

**åˆ†å¸ƒå¼é”ï¼ˆé‡ç‚¹ï¼‰**

**åŸºäºRedisåˆ†å¸ƒå¼é”å®ç°**

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/baf6f3084ba44ee38499612cde534ce9~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1830&h=1000&s=196128&e=png&b=fffdfd)

**åˆ†å¸ƒå¼é”å¯¹æ¯”**

| åˆ†ç±» | æ–¹æ¡ˆ | å®ç°åŸç† | ä¼˜ç‚¹ | ç¼ºç‚¹ |
| --- | --- | --- | --- | --- |
| åŸºäºæ•°æ®åº“ | åŸºäºmysql è¡¨å”¯ä¸€ç´¢å¼• | 1.è¡¨å¢åŠ å”¯ä¸€ç´¢å¼• 2.åŠ é”ï¼šæ‰§è¡Œinsertè¯­å¥ï¼Œè‹¥æŠ¥é”™ï¼Œåˆ™è¡¨æ˜åŠ é”å¤±è´¥ 3.è§£é”ï¼šæ‰§è¡Œdeleteè¯­å¥ | å®Œå…¨åˆ©ç”¨DBç°æœ‰èƒ½åŠ›ï¼Œå®ç°ç®€å• | 1.é”æ— è¶…æ—¶è‡ªåŠ¨å¤±æ•ˆæœºåˆ¶ï¼Œæœ‰æ­»é”é£é™© 2.ä¸æ”¯æŒé”é‡å…¥ï¼Œä¸æ”¯æŒé˜»å¡ç­‰å¾… 3.æ“ä½œæ•°æ®åº“å¼€é”€å¤§ï¼Œæ€§èƒ½ä¸é«˜ |
| åŸºäºMongoDB findAndModifyåŸå­æ“ä½œ | 1.åŠ é”ï¼šæ‰§è¡ŒfindAndModifyåŸå­å‘½ä»¤æŸ¥æ‰¾documentï¼Œè‹¥ä¸å­˜åœ¨åˆ™æ–°å¢  
2.è§£é”ï¼šåˆ é™¤document | å®ç°ä¹Ÿå¾ˆå®¹æ˜“ï¼Œè¾ƒåŸºäºMySQLå”¯ä¸€ç´¢å¼•çš„æ–¹æ¡ˆï¼Œæ€§èƒ½è¦å¥½å¾ˆå¤š | 1.å¤§éƒ¨åˆ†å…¬å¸æ•°æ®åº“ç”¨MySQLï¼Œå¯èƒ½ç¼ºä¹ç›¸åº”çš„MongoDBè¿ç»´ã€å¼€å‘äººå‘˜ 2.é”æ— è¶…æ—¶è‡ªåŠ¨å¤±æ•ˆæœºåˆ¶ |  |
| åŸºäºåˆ†å¸ƒå¼åè°ƒç³»ç»Ÿ | åŸºäºZooKeeper | 1.åŠ é”ï¼šåœ¨/lockç›®å½•ä¸‹åˆ›å»ºä¸´æ—¶æœ‰åºèŠ‚ç‚¹ï¼Œåˆ¤æ–­åˆ›å»ºçš„èŠ‚ç‚¹åºå·æ˜¯å¦æœ€å°ã€‚è‹¥æ˜¯ï¼Œåˆ™è¡¨ç¤ºè·å–åˆ°é”ï¼›å¦ï¼Œåˆ™åˆ™watch /lockç›®å½•ä¸‹åºå·æ¯”è‡ªèº«å°çš„å‰ä¸€ä¸ªèŠ‚ç‚¹ 2.è§£é”ï¼šåˆ é™¤èŠ‚ç‚¹ | 1.ç”±zkä¿éšœç³»ç»Ÿé«˜å¯ç”¨ 2.Curatoræ¡†æ¶å·²åŸç”Ÿæ”¯æŒç³»åˆ—åˆ†å¸ƒå¼é”å‘½ä»¤ï¼Œä½¿ç”¨ç®€å• | éœ€å•ç‹¬ç»´æŠ¤ä¸€å¥—zké›†ç¾¤ï¼Œç»´ä¿æˆæœ¬é«˜ |
| åŸºäºç¼“å­˜ | åŸºäºrediså‘½ä»¤ | 1\. åŠ é”ï¼šæ‰§è¡Œsetnxï¼Œè‹¥æˆåŠŸå†æ‰§è¡Œexpireæ·»åŠ è¿‡æœŸæ—¶é—´ 2. è§£é”ï¼šæ‰§è¡Œdeleteå‘½ä»¤ | å®ç°ç®€å•ï¼Œç›¸æ¯”æ•°æ®åº“å’Œåˆ†å¸ƒå¼ç³»ç»Ÿçš„å®ç°ï¼Œè¯¥æ–¹æ¡ˆæœ€è½»ï¼Œæ€§èƒ½æœ€å¥½ | 1.setnxå’Œexpireåˆ†2æ­¥æ‰§è¡Œï¼ŒéåŸå­æ“ä½œï¼›è‹¥setnxæ‰§è¡ŒæˆåŠŸï¼Œä½†expireæ‰§è¡Œå¤±è´¥ï¼Œå°±å¯èƒ½å‡ºç°æ­»é” 2.deleteå‘½ä»¤å­˜åœ¨è¯¯åˆ é™¤éå½“å‰çº¿ç¨‹æŒæœ‰çš„é”çš„å¯èƒ½ 3.ä¸æ”¯æŒé˜»å¡ç­‰å¾…ã€ä¸å¯é‡å…¥ |
| åŸºäºredis Luaè„šæœ¬èƒ½åŠ› | 1\. åŠ é”ï¼šæ‰§è¡ŒSET lock\_name random\_value EX seconds NX å‘½ä»¤  
2\. è§£é”ï¼šæ‰§è¡ŒLuaè„šæœ¬ï¼Œé‡Šæ”¾é”æ—¶éªŒè¯random\_value -- ARGV\[1\]ä¸ºrandom\_value, KEYS\[1\]ä¸ºlock_nameif redis.call("get", KEYS\[1\]) == ARGV\[1\] then return redis.call("del",KEYS\[1\])else return 0end | åŒä¸Šï¼›å®ç°é€»è¾‘ä¸Šä¹Ÿæ›´ä¸¥è°¨ï¼Œé™¤äº†å•ç‚¹é—®é¢˜ï¼Œç”Ÿäº§ç¯å¢ƒé‡‡ç”¨ç”¨è¿™ç§æ–¹æ¡ˆï¼Œé—®é¢˜ä¹Ÿä¸å¤§ã€‚ | ä¸æ”¯æŒé”é‡å…¥ï¼Œä¸æ”¯æŒé˜»å¡ç­‰å¾… |  |

**åˆ†å¸ƒå¼é”éœ€æ»¡è¶³å››ä¸ªæ¡ä»¶**

*   äº’æ–¥æ€§ã€‚åœ¨ä»»æ„æ—¶åˆ»ï¼Œåªæœ‰ä¸€ä¸ªå®¢æˆ·ç«¯èƒ½æŒæœ‰é”ã€‚
*   ä¸ä¼šå‘ç”Ÿæ­»é”ã€‚å³ä½¿æœ‰ä¸€ä¸ªå®¢æˆ·ç«¯åœ¨æŒæœ‰é”çš„æœŸé—´å´©æºƒè€Œæ²¡æœ‰ä¸»åŠ¨è§£é”ï¼Œä¹Ÿèƒ½ä¿è¯åç»­å…¶ä»–å®¢æˆ·ç«¯èƒ½åŠ é”ã€‚
*   è§£é“ƒè¿˜é¡»ç³»é“ƒäººï¼ŒåŠ é”å’Œè§£é”å¿…é¡»æ˜¯åŒä¸€ä¸ªå®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯è‡ªå·±ä¸èƒ½æŠŠåˆ«äººåŠ çš„é”ç»™è§£äº†ï¼Œå³ä¸èƒ½è¯¯è§£é”ã€‚
*   å…·æœ‰å®¹é”™æ€§ã€‚åªè¦å¤§å¤šæ•°RedisèŠ‚ç‚¹æ­£å¸¸è¿è¡Œï¼Œå®¢æˆ·ç«¯å°±èƒ½å¤Ÿè·å–å’Œé‡Šæ”¾é”ã€‚

**Redissonåˆ†å¸ƒå¼é”çš„å®ç°**

```java

Config config = new Config();
config.useSingleServer().setAddress("redis://127.0.0.1:5379").setPassword("123456").setDatabase(0);

RedissonClient redissonClient = Redisson.create(config);

RLock rLock = redissonClient.getLock(lockKey);
try {
    
     * 4.å°è¯•è·å–é”
     * waitTimeout å°è¯•è·å–é”çš„æœ€å¤§ç­‰å¾…æ—¶é—´ï¼Œè¶…è¿‡è¿™ä¸ªå€¼ï¼Œåˆ™è®¤ä¸ºè·å–é”å¤±è´¥
     * leaseTime   é”çš„æŒæœ‰æ—¶é—´,è¶…è¿‡è¿™ä¸ªæ—¶é—´é”ä¼šè‡ªåŠ¨å¤±æ•ˆï¼ˆå€¼åº”è®¾ç½®ä¸ºå¤§äºä¸šåŠ¡å¤„ç†çš„æ—¶é—´ï¼Œç¡®ä¿åœ¨é”æœ‰æ•ˆæœŸå†…ä¸šåŠ¡èƒ½å¤„ç†å®Œï¼‰
     */
    boolean res = rLock.tryLock((long)waitTimeout, (long)leaseTime, TimeUnit.SECONDS);
    if (res) {
        
    }
} catch (Exception e) {
    throw new RuntimeException("aquire lock fail");
}finally{
    
    rLock.unlock();
}

```

redissonè¿™ä¸ªæ¡†æ¶é‡åº¦ä¾èµ–äº†Luaè„šæœ¬å’ŒNettyï¼Œä»£ç å¾ˆç‰›é€¼ï¼Œå„ç§FutureåŠFutureListenerçš„å¼‚æ­¥ã€åŒæ­¥æ“ä½œè½¬æ¢ã€‚

> å¦‚æœè¦æ‰‹å†™ä¸€ä¸ªåˆ†å¸ƒå¼é”ç»„ä»¶ï¼Œæ€ä¹ˆåšï¼Ÿè‚¯å®šè¦å®šä¹‰2ä¸ªæ¥å£ï¼šåŠ é”ã€è§£é”ï¼›å¤§é“è‡³ç®€ï¼Œredissonçš„ä½œè€…å°±æ˜¯åœ¨åŠ é”å’Œè§£é”çš„æ‰§è¡Œå±‚é¢é‡‡ç”¨Luaè„šæœ¬ï¼Œé€¼æ ¼é«˜ï¼Œè€Œä¸”é‡è¦æœ‰åŸå­æ€§ä¿è¯ã€‚å½“ç„¶ï¼Œredissonçš„ä½œè€…æ¯•ç«Ÿç‰›é€¼ï¼ŒåŠ é”å’Œè§£é”è¿‡ç¨‹ä¸­è¿˜å·§å¦™åœ°åˆ©ç”¨äº†redisçš„å‘å¸ƒè®¢é˜…åŠŸèƒ½ã€‚

**åŠ é”å’Œè§£é”Luaè„šæœ¬å‰–æ**:

1ã€åŠ é”Luaè„šæœ¬

**è„šæœ¬å‚æ•°**

| å‚æ•° | ç¤ºä¾‹å€¼ | å«ä¹‰ |
| --- | --- | --- |
| KEYä¸ªæ•° | 1 | KEYä¸ªæ•° |
| KEYS\[1\] | my\_first\_lock_name | é”å |
| ARGV\[1\] | 60000 | æŒæœ‰é”çš„æœ‰æ•ˆæ—¶é—´ï¼š**æ¯«ç§’** |
| ARGV\[2\] | 58c62432-bb74-4d14-8a00-9908cc8b828f:1 | **å”¯ä¸€æ ‡è¯†**ï¼šè·å–é”æ—¶setçš„å”¯ä¸€å€¼ï¼Œå®ç°ä¸Šä¸ºredissonå®¢æˆ·ç«¯**ID(UUID)+çº¿ç¨‹ID** |

**è„šæœ¬å†…å®¹**

```powershell
-- è‹¥é”ä¸å­˜åœ¨ï¼šåˆ™æ–°å¢é”ï¼Œå¹¶è®¾ç½®é”é‡å…¥è®¡æ•°ä¸º1ã€è®¾ç½®é”è¿‡æœŸæ—¶é—´
if (redis.call('exists', KEYS[1]) == 0) then
    redis.call('hset', KEYS[1], ARGV[2], 1);
    redis.call('pexpire', KEYS[1], ARGV[1]);
    return nil;
end;
 
-- è‹¥é”å­˜åœ¨ï¼Œä¸”å”¯ä¸€æ ‡è¯†ä¹ŸåŒ¹é…ï¼šåˆ™è¡¨æ˜å½“å‰åŠ é”è¯·æ±‚ä¸ºé”é‡å…¥è¯·æ±‚ï¼Œæ•…é”é‡å…¥è®¡æ•°+1ï¼Œå¹¶å†æ¬¡è®¾ç½®é”è¿‡æœŸæ—¶é—´
if (redis.call('hexists', KEYS[1], ARGV[2]) == 1) then
    redis.call('hincrby', KEYS[1], ARGV[2], 1);
    redis.call('pexpire', KEYS[1], ARGV[1]);
    return nil;
end;
 
-- è‹¥é”å­˜åœ¨ï¼Œä½†å”¯ä¸€æ ‡è¯†ä¸åŒ¹é…ï¼šè¡¨æ˜é”æ˜¯è¢«å…¶ä»–çº¿ç¨‹å ç”¨ï¼Œå½“å‰çº¿ç¨‹æ— æƒè§£ä»–äººçš„é”ï¼Œç›´æ¥è¿”å›é”å‰©ä½™è¿‡æœŸæ—¶é—´
return redis.call('pttl', KEYS[1]);

```

**è„šæœ¬è§£è¯»**

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f9995fe462bc453a9c39d1b7e09b0a20~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1426&h=1006&s=116243&e=png&b=ffffff)

å½“ä¸”ä»…å½“è¿”å›nilï¼Œæ‰è¡¨ç¤ºåŠ é”æˆåŠŸï¼›å®¢æˆ·ç«¯éœ€è¦æ„ŸçŸ¥åŠ é”æ˜¯å¦æˆåŠŸçš„ç»“æœ

2ã€è§£é”Luaè„šæœ¬

**è„šæœ¬å…¥å‚**

| å‚æ•° | ç¤ºä¾‹å€¼ | å«ä¹‰ |
| --- | --- | --- |
| KEYä¸ªæ•° | 2 | KEYä¸ªæ•° |
| KEYS\[1\] | my\_first\_lock_name | é”å |
| KEYS\[2\] | redisson\_lock\_\_channel:{my\_first\_lock_name} | **è§£é”æ¶ˆæ¯PubSubé¢‘é“** |
| ARGV\[1\] | 0 | **redissonå®šä¹‰0è¡¨ç¤ºè§£é”æ¶ˆæ¯** |
| ARGV\[2\] | 30000 | è®¾ç½®é”çš„è¿‡æœŸæ—¶é—´ï¼›é»˜è®¤å€¼30ç§’ |
| ARGV\[3\] | 58c62432-bb74-4d14-8a00-9908cc8b828f:1 | å”¯ä¸€æ ‡è¯†ï¼›åŒåŠ é”æµç¨‹ |

**è„šæœ¬å†…å®¹**

```powershell
-- è‹¥é”ä¸å­˜åœ¨ï¼šåˆ™ç›´æ¥å¹¿æ’­è§£é”æ¶ˆæ¯ï¼Œå¹¶è¿”å›1
if (redis.call('exists', KEYS[1]) == 0) then
    redis.call('publish', KEYS[2], ARGV[1]);
    return 1; 
end;
 
-- è‹¥é”å­˜åœ¨ï¼Œä½†å”¯ä¸€æ ‡è¯†ä¸åŒ¹é…ï¼šåˆ™è¡¨æ˜é”è¢«å…¶ä»–çº¿ç¨‹å ç”¨ï¼Œå½“å‰çº¿ç¨‹ä¸å…è®¸è§£é”å…¶ä»–çº¿ç¨‹æŒæœ‰çš„é”
if (redis.call('hexists', KEYS[1], ARGV[3]) == 0) then
    return nil;
end; 
 
-- è‹¥é”å­˜åœ¨ï¼Œä¸”å”¯ä¸€æ ‡è¯†åŒ¹é…ï¼šåˆ™å…ˆå°†é”é‡å…¥è®¡æ•°å‡1
local counter = redis.call('hincrby', KEYS[1], ARGV[3], -1); 
if (counter > 0) then 
    -- é”é‡å…¥è®¡æ•°å‡1åè¿˜å¤§äº0ï¼šè¡¨æ˜å½“å‰çº¿ç¨‹æŒæœ‰çš„é”è¿˜æœ‰é‡å…¥ï¼Œä¸èƒ½è¿›è¡Œé”åˆ é™¤æ“ä½œï¼Œä½†å¯ä»¥å‹å¥½åœ°å¸®å¿™è®¾ç½®ä¸‹è¿‡æœŸæ—¶æœŸ
    redis.call('pexpire', KEYS[1], ARGV[2]); 
    return 0; 
else 
    -- é”é‡å…¥è®¡æ•°å·²ä¸º0ï¼šé—´æ¥è¡¨æ˜é”å·²é‡Šæ”¾äº†ã€‚ç›´æ¥åˆ é™¤æ‰é”ï¼Œå¹¶å¹¿æ’­è§£é”æ¶ˆæ¯ï¼Œå»å”¤é†’é‚£äº›äº‰æŠ¢è¿‡é”ä½†è¿˜å¤„äºé˜»å¡ä¸­çš„çº¿ç¨‹
    redis.call('del', KEYS[1]); 
    redis.call('publish', KEYS[2], ARGV[1]); 
    return 1;
end;
 
return nil;

```

**è„šæœ¬è§£è¯»** ![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c50fbe19cc5541349778324221be1ece~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1688&h=1334&s=149212&e=png&b=ffffff)
 å¹¿æ’­è§£é”æ¶ˆæ¯æœ‰ä»€ä¹ˆç”¨ï¼Ÿ æ˜¯ä¸ºäº†é€šçŸ¥å…¶ä»–äº‰æŠ¢é”é˜»å¡ä½çš„çº¿ç¨‹ï¼Œä»é˜»å¡ä¸­è§£é™¤ï¼Œå¹¶å†æ¬¡å»äº‰æŠ¢é”ã€‚

è¿”å›å€¼0ã€1ã€nilæœ‰ä»€ä¹ˆä¸ä¸€æ ·ï¼Ÿ å½“ä¸”ä»…å½“è¿”å›1ï¼Œæ‰è¡¨ç¤ºå½“å‰è¯·æ±‚çœŸæ­£è§¦å‘äº†è§£é”Luaè„šæœ¬ï¼›

**åŠ é”æºç **

åŠ é”æºç ä¸­tryAcquire(leaseTime, unit, threadId)æ–¹æ³•æ‰§è¡Œäº†åŠ é”Luaè„šæœ¬ã€‚ ç›´æ¥è¿›å…¥org.redisson.RedissonLock#tryLock(long, long, java.util.concurrent.TimeUnit)æºç 

```powershell
@Override
    public boolean tryLock(long waitTime, long leaseTime, TimeUnit unit) throws InterruptedException {
        // è·å–é”èƒ½å®¹å¿çš„æœ€å¤§ç­‰å¾…æ—¶é•¿
        long time = unit.toMillis(waitTime);
        long current = System.currentTimeMillis();
        final long threadId = Thread.currentThread().getId();
 
        // ã€æ ¸å¿ƒç‚¹1ã€‘å°è¯•è·å–é”ï¼Œè‹¥è¿”å›å€¼ä¸ºnullï¼Œåˆ™è¡¨ç¤ºå·²è·å–åˆ°é”
        Long ttl = tryAcquire(leaseTime, unit, threadId);
        // lock acquired
        if (ttl == null) {
            return true;
        }
 
        // è¿˜å¯ä»¥å®¹å¿çš„ç­‰å¾…æ—¶é•¿=è·å–é”èƒ½å®¹å¿çš„æœ€å¤§ç­‰å¾…æ—¶é•¿ - æ‰§è¡Œå®Œä¸Šè¿°æ“ä½œæµé€çš„æ—¶é—´
        time -= (System.currentTimeMillis() - current);
        if (time <= 0) {
            acquireFailed(threadId);
            return false;
        }
 
        current = System.currentTimeMillis();
        // ã€æ ¸å¿ƒç‚¹2ã€‘è®¢é˜…è§£é”æ¶ˆæ¯ï¼Œè§org.redisson.pubsub.LockPubSub#onMessage
        /**
     * 4.è®¢é˜…é”é‡Šæ”¾äº‹ä»¶ï¼Œå¹¶é€šè¿‡awaitæ–¹æ³•é˜»å¡ç­‰å¾…é”é‡Šæ”¾ï¼Œæœ‰æ•ˆçš„è§£å†³äº†æ— æ•ˆçš„é”ç”³è¯·æµªè´¹èµ„æºçš„é—®é¢˜ï¼š
     * åŸºäºä¿¡æ¯é‡ï¼Œå½“é”è¢«å…¶å®ƒèµ„æºå ç”¨æ—¶ï¼Œå½“å‰çº¿ç¨‹é€šè¿‡ Redis çš„ channel è®¢é˜…é”çš„é‡Šæ”¾äº‹ä»¶ï¼Œä¸€æ—¦é”é‡Šæ”¾ä¼šå‘æ¶ˆæ¯é€šçŸ¥å¾…ç­‰å¾…çš„çº¿ç¨‹è¿›è¡Œç«äº‰
     * å½“ this.awaitè¿”å›falseï¼Œè¯´æ˜ç­‰å¾…æ—¶é—´å·²ç»è¶…å‡ºè·å–é”æœ€å¤§ç­‰å¾…æ—¶é—´ï¼Œå–æ¶ˆè®¢é˜…å¹¶è¿”å›è·å–é”å¤±è´¥
     * å½“ this.awaitè¿”å›trueï¼Œè¿›å…¥å¾ªç¯å°è¯•è·å–é”
     */
        final RFuture<RedissonLockEntry> subscribeFuture = subscribe(threadId);
        //await æ–¹æ³•å†…éƒ¨æ˜¯ç”¨CountDownLatchæ¥å®ç°é˜»å¡ï¼Œè·å–subscribeå¼‚æ­¥æ‰§è¡Œçš„ç»“æœï¼ˆåº”ç”¨äº†Netty çš„ Futureï¼‰
        if (!await(subscribeFuture, time, TimeUnit.MILLISECONDS)) {
            if (!subscribeFuture.cancel(false)) {
                subscribeFuture.addListener(new FutureListener<RedissonLockEntry>() {
                    @Override
                    public void operationComplete(Future<RedissonLockEntry> future) throws Exception {
                        if (subscribeFuture.isSuccess()) {
                            unsubscribe(subscribeFuture, threadId);
                        }
                    }
                });
            }
            acquireFailed(threadId);
            return false;
        }
 
        // è®¢é˜…æˆåŠŸ
        try {
            // è¿˜å¯ä»¥å®¹å¿çš„ç­‰å¾…æ—¶é•¿=è·å–é”èƒ½å®¹å¿çš„æœ€å¤§ç­‰å¾…æ—¶é•¿ - æ‰§è¡Œå®Œä¸Šè¿°æ“ä½œæµé€çš„æ—¶é—´
            time -= (System.currentTimeMillis() - current);
            if (time <= 0) {
                // è¶…å‡ºå¯å®¹å¿çš„ç­‰å¾…æ—¶é•¿ï¼Œç›´æ¥è¿”å›è·å–é”å¤±è´¥
                acquireFailed(threadId);
                return false;
            }
 
            while (true) {
                long currentTime = System.currentTimeMillis();
                // å°è¯•è·å–é”ï¼›å¦‚æœé”è¢«å…¶ä»–çº¿ç¨‹å ç”¨ï¼Œå°±è¿”å›é”å‰©ä½™è¿‡æœŸæ—¶é—´ã€åŒä¸Šã€‘
                ttl = tryAcquire(leaseTime, unit, threadId);
                // lock acquired
                if (ttl == null) {
                    return true;
                }
 
                time -= (System.currentTimeMillis() - currentTime);
                if (time <= 0) {
                    acquireFailed(threadId);
                    return false;
                }
 
                // waiting for message
                currentTime = System.currentTimeMillis();
 
                // ã€æ ¸å¿ƒç‚¹3ã€‘æ ¹æ®é”TTLï¼Œè°ƒæ•´é˜»å¡ç­‰å¾…æ—¶é•¿ï¼›
                // æ³¨æ„ï¼šè¿™é‡Œå®ç°éå¸¸å·§å¦™ï¼Œ1ã€latchå…¶å®æ˜¯ä¸ªä¿¡å·é‡Semaphoreï¼Œè°ƒç”¨å…¶tryAcquireæ–¹æ³•ä¼šè®©å½“å‰çº¿ç¨‹é˜»å¡ä¸€æ®µæ—¶é—´ï¼Œé¿å…äº†åœ¨whileå¾ªç¯ä¸­é¢‘ç¹è¯·æ±‚è·å–é”ï¼›
               //2ã€è¯¥Semaphoreçš„releaseæ–¹æ³•ï¼Œä¼šåœ¨è®¢é˜…è§£é”æ¶ˆæ¯çš„ç›‘å¬å™¨æ¶ˆæ¯å¤„ç†æ–¹æ³•org.redisson.pubsub.LockPubSub#onMessageè°ƒç”¨ï¼›å½“å…¶ä»–çº¿ç¨‹é‡Šæ”¾äº†å ç”¨çš„é”ï¼Œä¼šå¹¿æ’­è§£é”æ¶ˆæ¯ï¼Œç›‘å¬å™¨æ¥æ”¶è§£é”æ¶ˆæ¯ï¼Œå¹¶é‡Šæ”¾ä¿¡å·é‡ï¼Œæœ€ç»ˆä¼šå”¤é†’é˜»å¡åœ¨è¿™é‡Œçš„çº¿ç¨‹ã€‚
                if (ttl >= 0 && ttl < time) {
                    getEntry(threadId).getLatch().tryAcquire(ttl, TimeUnit.MILLISECONDS);
                } else {
                    getEntry(threadId).getLatch().tryAcquire(time, TimeUnit.MILLISECONDS);
                }
 
                time -= (System.currentTimeMillis() - currentTime);
                if (time <= 0) {
                    acquireFailed(threadId);
                    return false;
                }
            }
        } finally {
            // å–æ¶ˆè§£é”æ¶ˆæ¯çš„è®¢é˜…
            unsubscribe(subscribeFuture, threadId);
        }
    }

```

tryAcquireçš„å®ç°ï¼ŒçœŸçš„å°±æ˜¯æ‰§è¡ŒLuaè„šæœ¬ï¼

```powershell
private Long tryAcquire(long leaseTime, TimeUnit unit, long threadId) {
    // tryAcquireAsyncå¼‚æ­¥æ‰§è¡ŒLuaè„šæœ¬ï¼Œgetæ–¹æ³•åŒæ­¥è·å–è¿”å›ç»“æœ
    return get(tryAcquireAsync(leaseTime, unit, threadId));
}
 
//  è§org.redisson.RedissonLock#tryAcquireAsync
private <T> RFuture<Long> tryAcquireAsync(long leaseTime, TimeUnit unit, final long threadId) {
    if (leaseTime != -1) {
        // å®è´¨æ˜¯å¼‚æ­¥æ‰§è¡ŒåŠ é”Luaè„šæœ¬
        return tryLockInnerAsync(leaseTime, unit, threadId, RedisCommands.EVAL_LONG);
    }
    RFuture<Long> ttlRemainingFuture = tryLockInnerAsync(commandExecutor.getConnectionManager().getCfg().getLockWatchdogTimeout(), TimeUnit.MILLISECONDS, threadId, RedisCommands.EVAL_LONG);
    ttlRemainingFuture.addListener(new FutureListener<Long>() {
        @Override
        public void operationComplete(Future<Long> future) throws Exception {
            //å…ˆåˆ¤æ–­è¿™ä¸ªå¼‚æ­¥æ“ä½œæœ‰æ²¡æœ‰æ‰§è¡ŒæˆåŠŸï¼Œå¦‚æœæ²¡æœ‰æˆåŠŸï¼Œç›´æ¥è¿”å›ï¼Œå¦‚æœæ‰§è¡ŒæˆåŠŸäº†ï¼Œå°±ä¼šåŒæ­¥è·å–ç»“æœ
            if (!future.isSuccess()) {
                return;
            }
 
            Long ttlRemaining = future.getNow();
            // lock acquired
            //å¦‚æœttlRemainingä¸ºnullï¼Œåˆ™ä¼šæ‰§è¡Œä¸€ä¸ªå®šæ—¶è°ƒåº¦çš„æ–¹æ³•scheduleExpirationRenewal
            if (ttlRemaining == null) {
                scheduleExpirationRenewal(threadId);
            }
        }
    });
    return ttlRemainingFuture;
}
 
// è§org.redisson.RedissonLock#tryLockInnerAsync
<T> RFuture<T> tryLockInnerAsync(long leaseTime, TimeUnit unit, long threadId, RedisStrictCommand<T> command) {
    internalLockLeaseTime = unit.toMillis(leaseTime);
 
    return commandExecutor.evalWriteAsync(getName(), LongCodec.INSTANCE, command,
              "if (redis.call('exists', KEYS[1]) == 0) then " +
                  "redis.call('hset', KEYS[1], ARGV[2], 1); " +
                  "redis.call('pexpire', KEYS[1], ARGV[1]); " +
                  "return nil; " +
              "end; " +
              "if (redis.call('hexists', KEYS[1], ARGV[2]) == 1) then " +
                  "redis.call('hincrby', KEYS[1], ARGV[2], 1); " +
                  "redis.call('pexpire', KEYS[1], ARGV[1]); " +
                  "return nil; " +
              "end; " +
              "return redis.call('pttl', KEYS[1]);",
                Collections.<Object>singletonList(getName()), internalLockLeaseTime, getLockName(threadId));
}

```

**åŠ é”æ€»ç»“**

> å°è¯•è·å–é”ï¼Œè¿™ä¸€æ­¥æ˜¯é€šè¿‡æ‰§è¡ŒåŠ é”Luaè„šæœ¬æ¥åšï¼› è‹¥ç¬¬ä¸€æ­¥æœªè·å–åˆ°é”ï¼Œåˆ™å»è®¢é˜…è§£é”æ¶ˆæ¯ï¼Œå½“è·å–é”åˆ°å‰©ä½™è¿‡æœŸæ—¶é—´åï¼Œè°ƒç”¨ä¿¡å·é‡æ–¹æ³•é˜»å¡ä½ï¼Œç›´åˆ°è¢«å”¤é†’æˆ–ç­‰å¾…è¶…æ—¶ ä¸€æ—¦æŒæœ‰é”çš„çº¿ç¨‹é‡Šæ”¾äº†é”ï¼Œå°±ä¼šå¹¿æ’­è§£é”æ¶ˆæ¯ã€‚äºæ˜¯ï¼Œç¬¬äºŒæ­¥ä¸­çš„è§£é”æ¶ˆæ¯çš„ç›‘å¬å™¨ä¼šé‡Šæ”¾ä¿¡å·é‡ï¼Œè·å–é”è¢«é˜»å¡çš„é‚£äº›çº¿ç¨‹å°±ä¼šè¢«å”¤é†’ï¼Œå¹¶é‡æ–°å°è¯•è·å–é”ã€‚

RedissonLockä¸­çš„å˜é‡internalLockLeaseTime,é»˜è®¤å€¼æ˜¯30000æ¯«ç§’ è°ƒç”¨tryLockInnerAsync()ä¼ å…¥çš„ä¸€ä¸ªä»è¿æ¥ç®¡ç†å™¨è·å–çš„getLockWatchdogTimeout(),é»˜è®¤å€¼ä¹Ÿæ˜¯30000æ¯«ç§’ è¿™äº›éƒ½å’Œredissonå®˜æ–¹æ–‡æ¡£æ‰€è¯´çš„**watchdog**æœºåˆ¶æœ‰å…³ï¼Œçœ‹é—¨ç‹—ï¼Œè¿˜æ˜¯å¾ˆå½¢è±¡çš„æè¿°è¿™ä¸€æœºåˆ¶

**çœ‹é—¨ç‹—åˆ°åº•åšäº†ä»€ä¹ˆ?**

å…ˆæ€è€ƒä¸€ä¸ªé—®é¢˜:

> å‡è®¾åœ¨ä¸€ä¸ªåˆ†å¸ƒå¼ç¯å¢ƒä¸‹ï¼Œå¤šä¸ªæœåŠ¡å®ä¾‹è¯·æ±‚è·å–é”ï¼Œå…¶ä¸­æœåŠ¡å®ä¾‹1æˆåŠŸè·å–åˆ°äº†é”ï¼Œåœ¨æ‰§è¡Œä¸šåŠ¡é€»è¾‘çš„è¿‡ç¨‹ä¸­ï¼ŒæœåŠ¡å®ä¾‹çªç„¶æŒ‚æ‰äº†æˆ–è€…hangä½äº†ï¼Œé‚£ä¹ˆè¿™ä¸ªé”ä¼šä¸ä¼šé‡Šæ”¾ï¼Œä»€ä¹ˆæ—¶å€™é‡Šæ”¾ï¼Ÿå›ç­”è¿™ä¸ªé—®é¢˜ï¼Œè‡ªç„¶æƒ³èµ·æ¥ä¹‹å‰æˆ‘ä»¬åˆ†æçš„luaè„šæœ¬ï¼Œå…¶ä¸­ç¬¬ä¸€æ¬¡åŠ é”çš„æ—¶å€™ä½¿ç”¨pexpireç»™é”keyè®¾ç½®äº†è¿‡æœŸæ—¶é—´ï¼Œé»˜è®¤30000æ¯«ç§’ï¼Œç”±æ­¤æ¥çœ‹å¦‚æœæœåŠ¡å®ä¾‹å®•æœºäº†ï¼Œé”æœ€ç»ˆä¹Ÿä¼šé‡Šæ”¾ï¼Œå…¶ä»–æœåŠ¡å®ä¾‹ä¹Ÿæ˜¯å¯ä»¥ç»§ç»­è·å–åˆ°é”æ‰§è¡Œä¸šåŠ¡ã€‚ä½†æ˜¯è¦æ˜¯30000æ¯«ç§’ä¹‹åå‘¢ï¼Œè¦æ˜¯æœåŠ¡å®ä¾‹1æ²¡æœ‰å®•æœºä½†æ˜¯ä¸šåŠ¡æ‰§è¡Œè¿˜æ²¡æœ‰ç»“æŸï¼Œæ‰€é‡Šæ”¾æ‰äº†å°±ä¼šå¯¼è‡´çº¿ç¨‹é—®é¢˜ï¼Œè¿™ä¸ªredissonæ˜¯æ€ä¹ˆè§£å†³çš„å‘¢ï¼Ÿ

**è‡ªåŠ¨å»¶é•¿é”æœ‰æ•ˆæœŸçš„æœºåˆ¶**

å¼‚æ­¥æ‰§è¡Œå®Œluaè„šæœ¬æ‰§è¡Œå®Œæˆä¹‹åï¼Œè®¾ç½®äº†ä¸€ä¸ªç›‘å¬å™¨ï¼Œæ¥å¤„ç†å¼‚æ­¥æ‰§è¡Œç»“æŸä¹‹åçš„ä¸€äº›å·¥ä½œã€‚åœ¨æ“ä½œå®Œæˆä¹‹åä¼šå»æ‰§è¡ŒoperationCompleteæ–¹æ³•ï¼Œå…ˆåˆ¤æ–­è¿™ä¸ªå¼‚æ­¥æ“ä½œæœ‰æ²¡æœ‰æ‰§è¡ŒæˆåŠŸï¼Œå¦‚æœæ²¡æœ‰æˆåŠŸï¼Œç›´æ¥è¿”å›ï¼Œå¦‚æœæ‰§è¡ŒæˆåŠŸäº†ï¼Œå°±ä¼šåŒæ­¥è·å–ç»“æœï¼Œå¦‚æœttlRemainingä¸ºnullï¼Œåˆ™ä¼šæ‰§è¡Œä¸€ä¸ªå®šæ—¶è°ƒåº¦çš„æ–¹æ³•**scheduleExpirationRenewal**,å›æƒ³ä¸€ä¸‹ä¹‹å‰çš„luaè„šæœ¬ï¼Œå½“åŠ é”é€»è¾‘å¤„ç†ç»“æŸï¼Œè¿”å›äº†ä¸€ä¸ªnil;å¦‚æ­¤è¯´æ¥ å°±ä¸€å®šä¼šèµ°å®šæ—¶ä»»åŠ¡äº†ã€‚

> **å®šæ—¶è°ƒåº¦scheduleExpirationRenewalä»£ç **

```powershell
private void scheduleExpirationRenewal(final long threadId) {
        if (expirationRenewalMap.containsKey(getEntryName())) {
            return;
        }
 
        Timeout task = commandExecutor.getConnectionManager().newTimeout(new TimerTask() {
            @Override
            public void run(Timeout timeout) throws Exception {
                
                RFuture<Boolean> future = commandExecutor.evalWriteAsync(getName(), LongCodec.INSTANCE, RedisCommands.EVAL_BOOLEAN,
                        "if (redis.call('hexists', KEYS[1], ARGV[2]) == 1) then " +
                            "redis.call('pexpire', KEYS[1], ARGV[1]); " +
                            "return 1; " +
                        "end; " +
                        "return 0;",
                          Collections.<Object>singletonList(getName()), internalLockLeaseTime, getLockName(threadId));
                
                future.addListener(new FutureListener<Boolean>() {
                    @Override
                    public void operationComplete(Future<Boolean> future) throws Exception {
                        expirationRenewalMap.remove(getEntryName());
                        if (!future.isSuccess()) {
                            log.error("Can't update lock " + getName() + " expiration", future.cause());
                            return;
                        }
                        
                        if (future.getNow()) {
                            // reschedule itself
                            scheduleExpirationRenewal(threadId);
                        }
                    }
                });
            }
        }, internalLockLeaseTime / 3, TimeUnit.MILLISECONDS);
 
        if (expirationRenewalMap.putIfAbsent(getEntryName(), task) != null) {
            task.cancel();
        }
    }

```

é¦–å…ˆï¼Œä¼šå…ˆåˆ¤æ–­åœ¨expirationRenewalMapä¸­æ˜¯å¦å­˜åœ¨äº†entryNameï¼Œè¿™æ˜¯ä¸ªmapç»“æ„ï¼Œä¸»è¦è¿˜æ˜¯åˆ¤æ–­åœ¨è¿™ä¸ªæœåŠ¡å®ä¾‹ä¸­çš„åŠ é”å®¢æˆ·ç«¯çš„é”keyæ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå·²ç»å­˜åœ¨äº†ï¼Œå°±ç›´æ¥è¿”å›ï¼›ç¬¬ä¸€æ¬¡åŠ é”ï¼Œè‚¯å®šæ˜¯ä¸å­˜åœ¨çš„ï¼Œæ¥ä¸‹æ¥å°±æ˜¯æäº†ä¸€ä¸ªTimeTaskï¼Œå»¶è¿ŸinternalLockLeaseTime/3ä¹‹åæ‰§è¡Œï¼Œè¿™é‡Œå°±ç”¨åˆ°äº†æ–‡ç« ä¸€å¼€å§‹å°±æåˆ°å¥‡å¦™çš„å˜é‡ï¼Œç®—ä¸‹æ¥å°±æ˜¯å¤§çº¦10ç§’é’Ÿæ‰§è¡Œä¸€æ¬¡ï¼Œè°ƒç”¨äº†ä¸€ä¸ªå¼‚æ­¥æ‰§è¡Œçš„æ–¹æ³•ï¼š

```powershell
                RFuture<Boolean> future = commandExecutor.evalWriteAsync(getName(), LongCodec.INSTANCE, RedisCommands.EVAL_BOOLEAN,
                        "if (redis.call('hexists', KEYS[1], ARGV[2]) == 1) then " +
                            "redis.call('pexpire', KEYS[1], ARGV[1]); " +
                            "return 1; " +
                        "end; " +
                        "return 0;",
                          Collections.<Object>singletonList(getName()), internalLockLeaseTime, getLockName(threadId));

```

> ä»»åŠ¡è°ƒåº¦å¼‚æ­¥æ‰§è¡Œå¹¶è®¾ç½®ç›‘å¬å™¨ï¼Œæ›´æ–°é”è¿‡æœŸæ—¶é—´å¤±è´¥åˆ™è¿”å›ï¼›è·å–å¼‚æ­¥æ‰§è¡Œç»“æœä¸ºtrueåˆ™æ¯éš”10ç§’æ‰§è¡Œä¸€æ¬¡ï¼Œç»­çº¦é”çš„è¿‡æœŸæ—¶é—´åˆ°30000æ¯«ç§’ï¼Œä¿è¯é”ä¸€ç›´åœ¨æ‰‹ä¸­ã€‚

> åŠ é”æˆåŠŸåï¼Œåœ¨æ‰§è¡Œä¸šåŠ¡æœŸé—´ï¼Œå…¶ä»–æœåŠ¡å®ä¾‹æˆ–è€…å½“å‰å®¢æˆ·ç«¯çš„å…¶ä»–çº¿ç¨‹è‹¥å°è¯•åŠ é”ï¼Œéƒ½ä¼šè¢«é˜»å¡ã€‚åŠ é”luaä»£ç ä¸­ï¼Œè‹¥é”keyå­˜åœ¨ä¸”å½“å‰å®¢æˆ·ç«¯å”¯ä¸€keyä¹Ÿå­˜åœ¨ï¼Œåˆ™è‡ªå¢é‡å…¥æ¬¡æ•°ï¼Œè®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œå¹¶è¿”å›nilï¼Œå®ç°é”çš„å¯é‡å…¥æ€§ã€‚å®šæ—¶è°ƒåº¦ä»»åŠ¡ä¼šç»§ç»­æ‰§è¡Œï¼Œå®Œæˆé”keyè¿‡æœŸæ—¶é—´çš„ç»­çº¦ã€‚

> å¦‚æœæ²¡æœ‰å‡ºç°é”ç»­çº¦çš„æƒ…å†µï¼Œç›´æ¥è¿”å›å½“å‰é”çš„å‰©ä½™æœ‰æ•ˆæœŸï¼Œä¸æ‰§è¡Œç»­çº¦é€»è¾‘ã€‚è‹¥åŠ é”æˆåŠŸï¼Œåˆ™è¿”å›ï¼›è‹¥åŠ é”å¤±è´¥ï¼Œåˆ™æ­»å¾ªç¯å°è¯•åŠ é”ï¼Œç­‰å¾…ä¸€æ®µæ—¶é—´åé‡è¯•ï¼Œç›´åˆ°ç¬¬ä¸€ä¸ªæœåŠ¡å®ä¾‹é‡Šæ”¾é”ã€‚è¿™æ ·å®ç°äº†é”çš„äº’æ–¥ã€‚

é”é‡Šæ”¾çš„é€»è¾‘

é”é‡Šæ”¾çš„é€»è¾‘ï¼Œè°ƒç”¨lock.unlock()ä¼šå¼‚æ­¥æ‰§è¡Œluaè„šæœ¬ï¼Œåˆ¤æ–­é”keyæ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨åˆ™è¿”å›ï¼›å­˜åœ¨åˆ™åˆ¤æ–­å”¯ä¸€keyçš„å€¼æ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨è¿”å›nilï¼›å­˜åœ¨åˆ™è‡ªå‡ä¸€å¹¶åˆ¤æ–­æ˜¯å¦å¤§äºé›¶ï¼Œå¤§äºé›¶è¿”å›0ï¼Œå¦åˆ™åˆ é™¤é”keyå¹¶è¿”å›1ã€‚å¦‚æœè¿”å›1ï¼Œå–æ¶ˆä¹‹å‰çš„ç»­çº¦ä»»åŠ¡ï¼Œå¤±è´¥åˆ™è®¾ç½®çŠ¶æ€ã€‚

**æºç è§£è¯»**

org.redisson.RedissonLock#unlockä»£ç 

```powershell
@Override
    public void unlock() {
        // æ‰§è¡Œè§£é”Luaè„šæœ¬ï¼Œè¿™é‡Œä¼ å…¥çº¿ç¨‹idï¼Œæ˜¯ä¸ºäº†ä¿è¯åŠ é”å’Œè§£é”æ˜¯åŒä¸€ä¸ªçº¿ç¨‹ï¼Œé¿å…è¯¯è§£é”å…¶ä»–çº¿ç¨‹å æœ‰çš„é”
        Boolean opStatus = get(unlockInnerAsync(Thread.currentThread().getId()));
        if (opStatus == null) {
            throw new IllegalMonitorStateException("attempt to unlock lock, not locked by current thread by node id: "
                    + id + " thread-id: " + Thread.currentThread().getId());
        }
        if (opStatus) {
            cancelExpirationRenewal();
        }
    }
 
// è§org.redisson.RedissonLock#unlockInnerAsync
protected RFuture<Boolean> unlockInnerAsync(long threadId) {
    return commandExecutor.evalWriteAsync(getName(), LongCodec.INSTANCE, RedisCommands.EVAL_BOOLEAN,
            "if (redis.call('exists', KEYS[1]) == 0) then " +
                "redis.call('publish', KEYS[2], ARGV[1]); " +
                "return 1; " +
            "end;" +
            "if (redis.call('hexists', KEYS[1], ARGV[3]) == 0) then " +
                "return nil;" +
            "end; " +
            "local counter = redis.call('hincrby', KEYS[1], ARGV[3], -1); " +
            "if (counter > 0) then " +
                "redis.call('pexpire', KEYS[1], ARGV[2]); " +
                "return 0; " +
            "else " +
                "redis.call('del', KEYS[1]); " +
                "redis.call('publish', KEYS[2], ARGV[1]); " +
                "return 1; "+
            "end; " +
            "return nil;",
            Arrays.<Object>asList(getName(), getChannelName()), LockPubSub.unlockMessage, internalLockLeaseTime, getLockName(threadId));
 
}

```

**åŠ é”&è§£é”æµç¨‹ä¸²èµ·æ¥**

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/dbb61d84058d47a7906e8dab1521d55f~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=2104&h=1548&s=364369&e=png&b=ffffff)
 æ€»ç»“

*   çº¿ç¨‹AæŠ¢åˆ°é”ï¼Œçº¿ç¨‹Bè®¢é˜…è§£é”æ¶ˆæ¯å†å°è¯•è·å–é”å¹¶é˜»å¡ç­‰å¾…ã€‚
*   çº¿ç¨‹Aé‡Šæ”¾é”å¹¶å¹¿æ’­è§£é”æ¶ˆæ¯ã€‚
*   LockPubSubæ”¶åˆ°æ¶ˆæ¯åé‡Šæ”¾ä¿¡å·é‡ï¼Œçº¿ç¨‹Bè¢«å”¤é†’åå†æ¬¡æŠ¢åˆ°é”å¹¶å¹²å®Œæ´»è§£é”ã€‚

[å‚è€ƒåœ°å€1 redisæ€§èƒ½ä¼˜åŒ–](https://link.juejin.cn/?target=https%3A%2F%2Fblog.csdn.net%2Fagonie201218%2Farticle%2Fdetails%2F130424297%3Fops_request_misc%3D%25257B%252522request%25255Fid%252522%25253A%252522170179053816800226510313%252522%25252C%252522scm%252522%25253A%25252220140713.130102334.pc%25255Fall.%252522%25257D%26request_id%3D170179053816800226510313%26biz_id%3D0%26utm_medium%3Ddistribute.pc_search_result.none-task-blog-2~all~first_rank_ecpm_v1~hot_rank-5-130424297-null-null.142%255Ev96%255Epc_search_result_base2%26utm_term%3Dredis%25E6%2580%25A7%25E8%2583%25BD%25E4%25BC%2598%25E5%258C%2596%26spm%3D1018.2226.3001.4449 "https://blog.csdn.net/agonie201218/article/details/130424297?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522170179053816800226510313%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fall.%2522%257D&request_id=170179053816800226510313&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~first_rank_ecpm_v1~hot_rank-5-130424297-null-null.142%5Ev96%5Epc_search_result_base2&utm_term=redis%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96&spm=1018.2226.3001.4449")

[å‚è€ƒåœ°å€2 redisæ€§èƒ½ä¼˜åŒ–](https://link.juejin.cn/?target=https%3A%2F%2Fblog.csdn.net%2Fzhengzhaoyang122%2Farticle%2Fdetails%2F112293953%3Fops_request_misc%3D%25257B%252522request%25255Fid%252522%25253A%252522170179053816800226510313%252522%25252C%252522scm%252522%25253A%25252220140713.130102334.pc%25255Fall.%252522%25257D%26request_id%3D170179053816800226510313%26biz_id%3D0%26utm_medium%3Ddistribute.pc_search_result.none-task-blog-2~all~first_rank_ecpm_v1~hot_rank-6-112293953-null-null.142%255Ev96%255Epc_search_result_base2%26utm_term%3Dredis%25E6%2580%25A7%25E8%2583%25BD%25E4%25BC%2598%25E5%258C%2596%26spm%3D1018.2226.3001.4449 "https://blog.csdn.net/zhengzhaoyang122/article/details/112293953?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522170179053816800226510313%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fall.%2522%257D&request_id=170179053816800226510313&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~first_rank_ecpm_v1~hot_rank-6-112293953-null-null.142%5Ev96%5Epc_search_result_base2&utm_term=redis%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96&spm=1018.2226.3001.4449")

* * *

[Redisé«˜å¯ç”¨å‚è€ƒåœ°å€](https://link.juejin.cn/?target=https%3A%2F%2Fblog.csdn.net%2Fweixin_44183721%2Farticle%2Fdetails%2F126195582%3Fops_request_misc%3D%25257B%252522request%25255Fid%252522%25253A%252522170179108616800213076720%252522%25252C%252522scm%252522%25253A%25252220140713.130102334.pc%25255Fall.%252522%25257D%26request_id%3D170179108616800213076720%26biz_id%3D0%26utm_medium%3Ddistribute.pc_search_result.none-task-blog-2~all~first_rank_ecpm_v1~hot_rank-7-126195582-null-null.142%255Ev96%255Epc_search_result_base2%26utm_term%3Dredis%25E9%25AB%2598%25E5%258F%25AF%25E7%2594%25A8%26spm%3D1018.2226.3001.4187 "https://blog.csdn.net/weixin_44183721/article/details/126195582?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522170179108616800213076720%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fall.%2522%257D&request_id=170179108616800213076720&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~first_rank_ecpm_v1~hot_rank-7-126195582-null-null.142%5Ev96%5Epc_search_result_base2&utm_term=redis%E9%AB%98%E5%8F%AF%E7%94%A8&spm=1018.2226.3001.4187")

[Redisäº‹åŠ¡](https://link.juejin.cn/?target=https%3A%2F%2Fblog.csdn.net%2Fqq_37284798%2Farticle%2Fdetails%2F128774826%3Fops_request_misc%3D%25257B%252522request%25255Fid%252522%25253A%252522170179146516800227449697%252522%25252C%252522scm%252522%25253A%25252220140713.130102334.pc%25255Fall.%252522%25257D%26request_id%3D170179146516800227449697%26biz_id%3D0%26utm_medium%3Ddistribute.pc_search_result.none-task-blog-2~all~first_rank_ecpm_v1~hot_rank-4-128774826-null-null.142%255Ev96%255Epc_search_result_base2%26utm_term%3Dredis%25E4%25BA%258B%25E5%258A%25A1%26spm%3D1018.2226.3001.4187 "https://blog.csdn.net/qq_37284798/article/details/128774826?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522170179146516800227449697%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fall.%2522%257D&request_id=170179146516800227449697&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~first_rank_ecpm_v1~hot_rank-4-128774826-null-null.142%5Ev96%5Epc_search_result_base2&utm_term=redis%E4%BA%8B%E5%8A%A1&spm=1018.2226.3001.4187")

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8ec2950cd2074f1981007d8b2fd88573~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1440&h=720&s=1102034&e=png&a=1&b=e67e77)

> Redisï¼ˆRemote Dictionary Serverï¼‰æ˜¯ä¸€ä¸ªå¼€æºçš„é«˜æ€§èƒ½é”®å€¼å¯¹ï¼ˆkey-valueï¼‰å­˜å‚¨ç³»ç»Ÿï¼Œé€šå¸¸ç”¨ä½œæ•°æ®åº“ã€ç¼“å­˜å’Œæ¶ˆæ¯ä»£ç†ã€‚å®ƒæ”¯æŒå¤šç§æ•°æ®ç»“æ„ï¼Œå¦‚å­—ç¬¦ä¸²ã€å“ˆå¸Œè¡¨ã€åˆ—è¡¨ã€é›†åˆå’Œæœ‰åºé›†åˆã€‚Rediså…·æœ‰åŸå­æ€§æ“ä½œï¼Œèƒ½å¤Ÿåœ¨å•ä¸ªå‘½ä»¤ä¸­å®ç°æ•°æ®çš„è¯»å–ã€å†™å…¥å’Œåˆ é™¤ï¼Œè¿™ä½¿å¾—å®ƒåœ¨å¤„ç†é«˜å¹¶å‘è¯·æ±‚æ—¶è¡¨ç°å‡ºè‰²ã€‚

*   é«˜é€Ÿç¼“å­˜ï¼šRedisä½¿ç”¨å†…å­˜å­˜å‚¨æ•°æ®ï¼Œå› æ­¤å®ƒå¯ä»¥åœ¨å¤§å¤šæ•°æ“ä½œä¸­æä¾›éå¸¸å¿«çš„å“åº”æ—¶é—´ã€‚
*   åŸå­æ€§æ“ä½œï¼šRedisçš„æ‰€æœ‰æ“ä½œéƒ½æ˜¯åŸå­çš„ï¼Œè¿™æ„å‘³ç€å®ƒä»¬è¦ä¹ˆå®Œå…¨æ‰§è¡Œï¼Œè¦ä¹ˆå®Œå…¨ä¸æ‰§è¡Œã€‚
*   æ•°æ®ç»“æ„å¤šæ ·æ€§ï¼šRedisæ”¯æŒå¤šç§æ•°æ®ç»“æ„ï¼Œä½¿å¾—å®ƒå¯ä»¥ç”¨ä½œå¤šç§ç”¨é€”ï¼Œå¦‚æ•°æ®åº“ã€ç¼“å­˜å’Œæ¶ˆæ¯ä»£ç†ã€‚
*   æŒä¹…åŒ–ï¼šè™½ç„¶ä¸»è¦ä½¿ç”¨å†…å­˜å­˜å‚¨ï¼Œä½†Redisä¹Ÿæ”¯æŒå°†æ•°æ®æŒä¹…åŒ–åˆ°ç£ç›˜ã€‚
*   å‘å¸ƒ/è®¢é˜…ï¼šRedisæ”¯æŒå‘å¸ƒ/è®¢é˜…æ¨¡å‹ï¼Œä½¿å…¶æˆä¸ºå®ç°å®æ—¶åº”ç”¨çš„ç†æƒ³é€‰æ‹©ã€‚
*   äº‹åŠ¡å¤„ç†ï¼šRedisæ”¯æŒäº‹åŠ¡å¤„ç†ï¼Œå³ä¸€ç³»åˆ—æŒ‰é¡ºåºæ‰§è¡Œçš„å‘½ä»¤ï¼Œè¦ä¹ˆå…¨éƒ¨æ‰§è¡Œï¼Œè¦ä¹ˆå…¨éƒ¨ä¸æ‰§è¡Œã€‚
*   Luaè„šæœ¬å¤„ç†ï¼šRedisæ”¯æŒLuaè„šæœ¬å¤„ç†ï¼Œå¯ä»¥åœ¨æœåŠ¡å™¨ç«¯æ‰§è¡Œä¸€æ®µLuaè„šæœ¬ã€‚
*   åˆ†å¸ƒå¼ï¼šé€šè¿‡Redisçš„åˆ†ç‰‡ï¼Œå¯ä»¥å¾ˆå®¹æ˜“åœ°å®ç°æ•°æ®çš„åˆ†å¸ƒå¼å­˜å‚¨å’Œå¤„ç†ã€‚

Redisæ˜¯ä¸€ä¸ªåŠŸèƒ½ä¸°å¯Œã€æ€§èƒ½å“è¶Šçš„é”®å€¼å¯¹å­˜å‚¨ç³»ç»Ÿï¼Œé€‚ç”¨äºå„ç§åº”ç”¨åœºæ™¯ï¼Œæ— è®ºæ˜¯ä½œä¸ºæ•°æ®åº“ã€ç¼“å­˜è¿˜æ˜¯æ¶ˆæ¯ä»£ç†ï¼Œéƒ½èƒ½æä¾›å‡ºè‰²çš„æ€§èƒ½å’Œå¯é æ€§ã€‚