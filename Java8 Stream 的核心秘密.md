# Java8 Stream çš„æ ¸å¿ƒç§˜å¯†
å°ä¼™ä¼´ä»¬å¥½å‘€ï¼Œæˆ‘æ˜¯ 4yeï¼Œä»Šå¤©æ¥åˆ†äº«ä¸‹ **Java8 Stream çš„æºç **

![](https://static001.geekbang.org/infoq/47/4768bf7d847ea53177707fa2167aa3c0.png)

### æ ¸å¿ƒå›é¡¾

> 1.  stream æ˜¯ä¸€æ¬¡æ€§çš„ï¼Œä¸æ˜¯æ•°æ®ç»“æ„ï¼Œä¸å­˜å‚¨æ•°æ®ï¼Œä¸æ”¹å˜æºæ•°æ®.ã€‚
>     
> 2.  API åˆ†ä¸ºç»ˆç«¯å’Œä¸­é—´æ“ä½œï¼Œä¸­é—´æ“ä½œæ˜¯æƒ°æ€§çš„ï¼Œç¢°åˆ°ç»ˆç«¯æ‰å»æ‰§è¡Œã€‚
>     
> 3.  ä¸­é—´æ“ä½œæœ‰æ— çŠ¶æ€å’Œæœ‰çŠ¶æ€ä¹‹åˆ†ï¼Œæœ‰çŠ¶æ€éœ€è¦æ›´æ”¹ä¸Šä¸€æ­¥æ“ä½œè·å¾—çš„æ‰€æœ‰å…ƒç´ ï¼Œæ‰å¯ä»¥è¿›è¡Œä¸‹ä¸€æ­¥æ“ä½œï¼Œæ¯”å¦‚ æ’åº sortedï¼Œå»é‡ distinctï¼Œè·³è¿‡ skipï¼Œé™åˆ¶ limit è¿™å››ä¸ªï¼Œéœ€è¦å¤šè¿­ä»£ä¸€æ¬¡ã€‚
>     
> 4.  ç»ˆç«¯æ“ä½œæœ‰çŸ­è·¯ä¸å¦ä¹‹åˆ†ï¼ŒçŸ­è·¯æ“ä½œæœ‰ anyMatch, allMatch, noneMatch, findFirst, findAny
>     

### æ•´ä½“æ¦‚è§ˆ

è¿™é‡Œåˆ—å‡ºä¸€äº›é‡è¦çš„ç±»ï¼Œæ˜¯çœ‹æºç è¿‡ç¨‹ä¸­å¿…é¡»äº†è§£çš„ã€‚

![](https://static001.geekbang.org/infoq/69/69033f50d0d01535eb3756684b992174.png)

æ¯”å¦‚ ï¼š

*   **Sink** æ¥å£æ˜¯æ•°æ®å®é™…æ“ä½œçš„åœ°æ–¹ï¼Œæ ¸å¿ƒæ–¹æ³•ï¼š beginï¼Œacceptï¼Œend
    
*   **AbstractPipeline** æŠ½è±¡ç±»æ˜¯æ ¸å¿ƒçš„æ•°æ®ç»“æ„ï¼ŒåŒé“¾è¡¨
    

### demo ä»£ç 

è¿™é‡Œæ²¿ç”¨ä¸Šæ–‡çš„ä¾‹å­

```
Student aStud = new Student(1, "a");
        Student bStud = new Student(2, "b");
        Student cStud = new Student(3, null);


        List<Student> collect1 = Stream.of(aStud, bStud, cStud).collect(Collectors.toList());
        collect1.forEach(System.out::println);

        List<String> studNameList = studentList.stream()
                .map(Student::getName)
                .filter(Objects::nonNull)
                .map(String::toUpperCase)
                .sorted()
                .map(e -> e + "c")
                .collect(Collectors.toList());
```

### æ­¥éª¤è§£æ

éƒ½åœ¨è¿™é‡Œäº† ğŸ‘‡

![](https://static001.geekbang.org/infoq/0b/0bb27f5f4fde04a72c04bb1637ce169a.png)

è¿™é‡Œæ­¥éª¤å¤ªå¤šäº†ï¼Œå°±ä¸ä¸€ä¸€æ”¾å‡ºæ¥äº† ï¼Œåˆ—ä¸‹æ ¸å¿ƒ

1.  wrapSink, **åˆ›å»º Sink é“¾**ï¼Œå°†ç®¡é“çš„ Sink æ“ä½œè¿æ¥åœ¨ä¸€èµ·
    
2.  copyInto , **å¤„ç†æ•°æ®**
    

### wrapSink()

å¼€å§‹å¥—å¨ƒï¼Œä» ReducingSink å¾€å‰å¥—

![](https://static001.geekbang.org/infoq/a8/a8fd68bfc5cf046d3a169a2d4290df36.png)

opWarpSink æ–¹æ³•è°ƒç”¨çš„æ˜¯æ¯ä¸€æ­¥ **ä¸­é—´æ“ä½œ** ä¸­çš„æ–¹æ³•

![](https://static001.geekbang.org/infoq/2a/2a320ec39d25447d43365bdf36e0f84b.png)

é€šè¿‡ **å•é“¾è¡¨** çš„å½¢å¼å°†ä»–ä»¬è”ç³»åœ¨ä¸€èµ·

![](https://static001.geekbang.org/infoq/78/78fb29af024eeae788a96df4ffeab515.png)

Sink é“¾åˆ›å»ºç»“æœ

![](https://static001.geekbang.org/infoq/ca/cae90ee18b6b334226f89ce61d7cbb77.png)

### copyInto()

è¿™é‡Œåˆ¤æ–­æ˜¯ä¸æ˜¯ **çŸ­è·¯æ“ä½œ** ï¼Œç„¶åå°±å»æ‰§è¡Œ Sink çš„ beginï¼Œacceptï¼Œend æ–¹æ³•ã€‚

é€šè¿‡ **forEachRemaining** è¿›è¡Œå†…éƒ¨è¿­ä»£ï¼Œè¿™ä¸ªæ˜¯ **Spliterator** çš„æ–¹æ³•ã€‚

![](https://static001.geekbang.org/infoq/d9/d988be5447c107ed83cfc26537486356.png)

map é“¾èŠ‚ç‚¹ï¼Œç›´æ¥è°ƒç”¨ä¼ è¿›æ¥çš„æ–¹æ³•ï¼Œ

![](https://static001.geekbang.org/infoq/d6/d6fbf04011dc4222e9a44f9fea5553f1.png)

filter é“¾èŠ‚ç‚¹ï¼Œå¤šä¸€æ­¥åˆ¤æ–­

![](https://static001.geekbang.org/infoq/71/7160082a2d3bcefcb6295784e1935cd1.png)

sorted èŠ‚ç‚¹ï¼Œæ·»åŠ åˆ° list ä¸­ã€‚

> æ³¨æ„ï¼Œæ­¤æ—¶æ²¡æœ‰ç»§ç»­è°ƒç”¨ **downstream.accept** æ–¹æ³•ï¼
> 
> æ„å‘³ç€ï¼Œæˆ‘ä»¬ä»£ç ä¸­çš„ 5 ä¸ªä¸­é—´æ­¥éª¤åªæ‰§è¡Œäº†å‰ 3 ä¸ªã€‚

![](https://static001.geekbang.org/infoq/2e/2ea663434c9a51ce9ec6bee04e75f68a.png)

ä¸è¿‡åˆ«æ‹…å¿ƒï¼Œ sorted é“¾èŠ‚ç‚¹ä¸­å®ƒé‡å†™äº†è¿™ä¸ª endï¼Œå¹¶å¼€å¯å¯¹æ–°æ•°æ®çš„**æ–°ä¸€è½®éå†**ï¼

> è¿™å°±æ˜¯æˆ‘ä»¬æåˆ°çš„ï¼Œ**æœ‰çŠ¶æ€ä¸­é—´æ“ä½œå¤šä¸€æ¬¡è¿­ä»£çš„åŸå› **

![](https://static001.geekbang.org/infoq/1b/1bc839a88e40aa7d13b877739f74efdd.png)

æœ€åå‘¢ï¼Œæ˜¯æ¥åˆ°ç»ˆæ­¢æ“ä½œ **TerminalOp** ä¸­çš„ acceptï¼Œè¿™é‡Œæ‰§è¡Œçš„æ˜¯ list çš„ add æ–¹æ³•ï¼ˆæˆ‘ä»¬è°ƒç”¨ **Collectors.toList()** ä¸­æ„å»ºçš„ï¼‰ï¼Œè‡³æ­¤ï¼Œæ•°æ®æ·»åŠ åˆ° state ä¸­

![](https://static001.geekbang.org/infoq/24/24e0625eec2a020e0ae1c8ae6eea3ea6.png)

![](https://static001.geekbang.org/infoq/b1/b1207a06c6ad9bfe1b2bb7003f657e33.png)

è·å–æ•°æ®ï¼ŒReducingSink ç»§æ‰¿äº† Box è¿™ä¸ªæŠ½è±¡ç±»ï¼Œæœ€å get æ–¹æ³•å¾—åˆ°ç»“æœã€‚

![](https://static001.geekbang.org/infoq/17/17da16098d953d96e8c786527e4eedcb.png)

### æ€»ç»“

ä»£ç å¯¹åº”çš„**æ‰§è¡Œæµç¨‹**ğŸ‘‡

1.  å…ˆåˆ›å»ºæµï¼Œå‡ºç°äº† Head èŠ‚ç‚¹
    
2.  åˆ›å»ºä¸­é—´ç®¡é“ Pipeline
    
3.  è°ƒç”¨ç»ˆç«¯æ“ä½œåæœ‰ä¸‰æ­¥ ğŸ‘‡
    
4.  ï¼ˆä¸€ï¼‰å°†ä¸­é—´ç®¡é“çš„ Sink æ“ä½œè¿æ¥åœ¨ä¸€èµ· ï¼ˆ**wrapSink**ï¼‰ï¼ˆäºŒï¼‰å¤„ç†æ•°æ® ï¼ˆ**copyInto**ï¼‰ï¼Œä¸»è¦è°ƒç”¨ Sink ä¸­çš„ beginï¼Œ**accept**ï¼ˆæ ¸å¿ƒï¼‰ï¼Œend æ“ä½œï¼ˆä¸‰ï¼‰è¿”å›ç»“æœï¼ŒReducingSink ä¸­çš„ **get** æ–¹æ³•
    

![](https://static001.geekbang.org/infoq/77/778abe7161ded6ba585e90d303349213.png)

> ä¸»è¦è®°ä½è¿™ä¸ª **wrapSink** æ–¹æ³• å’Œ **copyInto** æ–¹æ³•ã€‚
> 
> ä¸€ä¸ªå¥—å¨ƒï¼Œä¸€ä¸ªè°ƒç”¨ beginï¼Œacceptï¼Œend ç­‰æ–¹æ³•ã€‚

é‚£ä¹ˆï¼Œè¿™ä¸ª stream çš„**åŸç†æœºåˆ¶**å°±å‡ºæ¥äº†ï¼š

> åˆ©ç”¨ **wrapSink** æ–¹æ³•å°†å„ä¸ªä¸­é—´æ“ä½œä¸­çš„ **Sink** **åµŒå¥—**åœ¨ä¸€èµ·ï¼Œç„¶åæ¥åˆ° **copyInto** æ–¹æ³•ï¼Œè°ƒç”¨ begin é€šçŸ¥å„ä¸ª Sink åšå¥½å‡†å¤‡ï¼Œæ¥ç€è¿›è¡Œ**å†…éƒ¨è¿­ä»£**è°ƒç”¨ **accept** æ–¹æ³•ï¼Œå†è°ƒç”¨ end æ–¹æ³•å®Œæˆæ•°æ®çš„æ“ä½œï¼Œæœ€åé€šè¿‡ get æ–¹æ³•ï¼Œè·å–æ–°å®¹å™¨ä¸­çš„æ•°æ®ï¼Œä¾¿æ˜¯ç»“æœäº†ã€‚

æ­¤å¤–ï¼Œæºç çš„ **é“¾å¼è°ƒç”¨ API å†™æ³•** ï¼Œ**è®¾è®¡æ¨¡å¼ **çš„ä½¿ç”¨ä»¥åŠ **æ³›å‹** ï¼Œ**å››å¤§å‡½æ•°å¼æ¥å£** ç»„åˆæ„å»ºçš„é«˜åº¦æŠ½è±¡ï¼Œå°è£…å†™æ³•ï¼Œå¯¹æˆ‘ä»¬çš„ç¼–ç èƒ½åŠ›ï¼Œæºç é˜…è¯»èƒ½åŠ›ä¹Ÿæœ‰å¾ˆå¤§çš„å¸®åŠ©ï¼

æ¯”å¦‚ è¿™ä¸ª Consumer+Function æ¥å£çš„ç»„åˆï¼Œé…åˆæ³›å‹ä¸Šä¸‹é™çš„ä½¿ç”¨

![](https://static001.geekbang.org/infoq/d6/d6fbf04011dc4222e9a44f9fea5553f1.png)

æºç ä¸­ **è®¿é—®è€…æ¨¡å¼**ï¼Œ**å·¥å‚æ¨¡å¼** ç­‰è®¾è®¡æ¨¡å¼çš„å½±å­

> è®¿é—®è€…æ¨¡å¼ï¼š **å°†æ•°æ®ç»“æ„ä¸æ•°æ®æ“ä½œåˆ†ç¦»**ã€‚
> 
> å¯¹åº”æºç ï¼šæ•°æ®ç»“æ„æ˜¯ Pipeline ï¼Œæ“ä½œæ˜¯ Sink

![](https://static001.geekbang.org/infoq/a5/a57baab22bc1c60fb90d9c9c523475f5.png)

å¯¹ stream çš„ç‰¹ç‚¹æ›´åŠ ç†Ÿæ‚‰

æ¯”å¦‚ï¼š

1.  stream æ˜¯ä¸€æ¬¡æ€§çš„ï¼Œä¸æ˜¯æ•°æ®ç»“æ„ï¼Œä¸å­˜å‚¨æ•°æ®ï¼Œä¸æ”¹å˜æºæ•°æ®.ã€‚
    
2.  ä¸­é—´æ“ä½œæ˜¯æƒ°æ€§çš„ï¼Œé‡åˆ° ç»ˆç«¯æ“ä½œæ‰çœŸæ­£æ‰§è¡Œ
    
3.  æœ‰çŠ¶æ€çš„ä¸­é—´æ“ä½œçš„ç‰¹æ®Šä¹‹å¤„åœ¨äºå¤šè¿­ä»£ä¸€æ¬¡
    
4.  å†…éƒ¨è¿­ä»£
    
5.  ç»ˆç«¯æ“ä½œä¸»è¦åšäº†ä¸¤ä»¶äº‹ï¼Œä¸²è¿ä¸­é—´æ“ä½œï¼Œè°ƒç”¨ accept æ–¹æ³•å¤„ç†æ•°æ®
    

å½“ç„¶è¿™é‡Œæˆ‘ä¹Ÿåªæµ‹è¯•äº† éçŸ­è·¯æ¨¡å¼ï¼ŒçŸ­è·¯æ¨¡å¼åˆæ˜¯æ€æ ·è®¾è®¡çš„å‘¢ï¼Œå°ä¼™ä¼´ä»¬å¯ä»¥è‡ªå·±ä¸Šæ‰‹ debug ä¸‹ï¼ŒåŠ æ·±å°è±¡ã€‚

